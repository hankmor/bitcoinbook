<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.22">
<title>The Bitcoin Network</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="bitcoin_network_ch08">The Bitcoin Network</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bitcoin is structured as a peer-to-peer network architecture on
top of the internet. The term peer-to-peer, or P2P, means that the
full nodes that participate in the network are peers to each other, that
they can all perform the same functions, and that there are no "special" nodes.
The network nodes
interconnect in a mesh network with a "flat" topology. There is no
server, no centralized service, and no hierarchy within the network.
Nodes in a P2P network both provide and consume services at the same
time. P2P
networks are inherently resilient, decentralized, and open. A preeminent
example of a P2P network architecture was the early internet itself,
where nodes on the IP network were equal. Today&#8217;s internet architecture
is more hierarchical, but the Internet Protocol still retains its
flat-topology essence. Beyond Bitcoin and the internet, the largest and most successful
application of P2P technologies is file sharing, with Napster as the
pioneer and BitTorrent as the most recent evolution of the architecture.</p>
</div>
<div class="paragraph">
<p>Bitcoin&#8217;s P2P network architecture is much more than a topology choice.
Bitcoin is a P2P digital cash system by design, and the network
architecture is both a reflection and a foundation of that core
characteristic. Decentralization of control is a core design principle
that can only be achieved and maintained by a flat and decentralized P2P
consensus network.</p>
</div>
<div class="paragraph">
<p>The term "Bitcoin network" refers to
the collection of nodes running the Bitcoin P2P protocol. In addition to
the Bitcoin P2P protocol, there are other protocols that
are used for mining and lightweight wallets. These additional
protocols are provided by gateway routing servers that access the
Bitcoin network using the Bitcoin P2P protocol and then extend that
network to nodes running other protocols. For example, Stratum servers
connect Stratum mining nodes via the Stratum protocol to the main
Bitcoin network and bridge the Stratum protocol to the Bitcoin P2P
protocol. We will describe some of the most commonly used of those
protocols in this chapter in addition to the base Bitcoin P2P protocol.</p>
</div>
<div class="sect2">
<h3 id="_node_types_and_roles">Node Types and Roles</h3>
<div class="paragraph">
<p>Although full nodes (peers) in the Bitcoin P2P network are equal to each other,
they may take on different roles depending on the functionality they are
supporting. A Bitcoin full node validates blocks and may contain other
functions, such as routing, mining, and wallet services.</p>
</div>
<div class="paragraph">
<p>Some nodes, called <em>archival full nodes</em>, also maintain a
complete and up-to-date copy of the blockchain.
Those nodes can
serve data to clients that store
only a subset of the blockchain and partly verify transactions using a method
called <em>simplified payment verification</em>, or SPV. These clients are known as lightweight clients.</p>
</div>
<div class="paragraph">
<p>Miners compete to create new blocks by
running specialized hardware to solve the proof-of-work algorithm. Some
miners operate full nodes, validating every block on the
blockchain, while others are clients participating in pool
mining and depending on a pool server to provide them with work.</p>
</div>
<div class="paragraph">
<p>User wallets might connect to the user&#8217;s own full node, as is sometimes the case with
desktop Bitcoin clients, but many user wallets, especially
those running on resource-constrained devices such as smartphones, are
lightweight nodes.</p>
</div>
<div class="paragraph">
<p>In addition to the main node types on the Bitcoin P2P protocol, there
are servers and nodes running other protocols, such as specialized
mining pool protocols and lightweight client-access protocols.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_network">The Network</h3>
<div class="paragraph">
<p>As of this writing, the main Bitcoin network,
running the Bitcoin P2P protocol, consists of about 10,000
listening nodes running various versions of Bitcoin Core and a few
hundred nodes running various other implementations of the Bitcoin P2P
protocol such as BitcoinJ, btcd, and bcoin. A small
percentage of the nodes on the Bitcoin P2P network are also mining
nodes. Various individuals and companies interface with the Bitcoin
network by running archival full nodes,
with full copies of the blockchain and a network node, but without
mining or wallet functions. These nodes act as network edge routers,
allowing various other services (exchanges, wallets, block explorers,
merchant payment processing) to be built on top.</p>
</div>
</div>
<div class="sect2 less_space pagebreak-before">
<h3 id="_compact_block_relay">Compact Block Relay</h3>
<div class="paragraph">
<p>When a miner finds a new block, they announce it to the Bitcoin network
(which includes other miners).  The miner who found that block can start
building on top of it immediately; all other miners who haven&#8217;t learned
about the block yet will continue building on top of the previous block
until they do learn about it.</p>
</div>
<div class="paragraph">
<p>If, before they learn about the new block, one of those other
miners creates a block, their block will be in competition with the
first miner&#8217;s new block.  Only one of the blocks will ever be included
in the blockchain used by all full nodes, and miners only get paid for
blocks that are widely accepted.</p>
</div>
<div class="paragraph">
<p>Whichever block has a second block built on top of it first wins (unless
there&#8217;s another near-tie), which is called a <em>block-finding race</em> and is
illustrated in <a href="#mining_race">A blockchain fork requiring a mining race.</a>.
Block-finding races give the advantage to the largest miners, so they
act in opposition to Bitcoin&#8217;s essential decentralization.  To prevent
block-finding races and allow miners of any size to participate equally
in the lottery that is Bitcoin mining, it&#8217;s extremely useful to minimize
the time between when one miner announces a new block and when other
miners receive that block.</p>
</div>
<div id="mining_race" class="imageblock">
<div class="content">
<img src="images/mbc3_1001.png" alt="Mining race">
</div>
<div class="title">Figure 1. A blockchain fork requiring a mining race.</div>
</div>
<div class="paragraph">
<p>In 2015, a new version of Bitcoin Core added a feature called
<em>compact block relay</em> (specified in BIP152) that allows transferring new
blocks both faster and with less bandwidth.</p>
</div>
<div class="paragraph">
<p>As background, full nodes that relay unconfirmed transactions also store
many of those transactions in their mempools (see <a href="#mempool">Mempools and Orphan Pools</a>).  When
some of those transactions are confirmed in a new block, the node
doesn&#8217;t need to receive a second copy of those transactions.</p>
</div>
<div class="paragraph">
<p>Instead of receiving redundant unconfirmed transactions, compact blocks
allow a peer to instead send a short 6-byte identifier for each transaction.
When your node receives a compact block with one or more identifiers, it
checks its mempool for those transactions and uses them if they are
found.  For any transaction that isn&#8217;t found in your local node&#8217;s
mempool, your node can send a request to the peer for a copy.</p>
</div>
<div class="paragraph">
<p>Conversely, if the remote peer believes your node&#8217;s mempool doesn&#8217;t have
some of the transactions that appear in the block, it can include a copy of
those transactions in the compact block.  For example, Bitcoin Core
always sends a block&#8217;s coinbase transaction.</p>
</div>
<div class="paragraph">
<p>If the remote peer guesses correctly about what transactions your node
has in its mempool, and which it does not, it will send a block nearly
as efficiently as is theoretically possible (for a typical block, it&#8217;ll
be between 97% and 99% efficient).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Compact block relay does not decrease the size of blocks.  It just
prevents the redundant transfer of information that a node already has.
When a node doesn&#8217;t previously have information about a block, for
example when a node is first started, it must receive complete copies of
each block.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are two modes that Bitcoin Core currently implements for sending
compact blocks, illustrated in <a href="#bip152_illustration">BIP152 modes compared (from BIP152).  The shaded bar indicates the time it takes the node to validate the block.</a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Low-bandwidth mode</dt>
<dd>
<p>When your node requests that a peer use low-bandwidth mode (the default),
that peer will tell your node the 32-byte identifier (header hash) of a
new block but will not send your node any details about it.  If your
node acquires that block first from another source, this avoids
wasting any more of your bandwidth acquiring a redundant copy of that
block.  If your node does need the block, it will request a compact
block.</p>
</dd>
<dt class="hdlist1">High-bandwidth mode</dt>
<dd>
<p>When your node requests that a peer use high-bandwidth mode, that peer
will send your node a compact block for a new block even before it has
fully verified that the block is valid.  The only validation the peer
will perform is ensuring that the block&#8217;s header contains the correct
amount of proof of work.  Since proof of work is expensive to generate
(about $150,000 USD at the time of writing), it&#8217;s unlikely that a
miner would fake it just to waste the bandwidth of relay nodes.
Skipping validation before relay allows new blocks to travel across
the network with minimal delays at each hop.</p>
<div class="paragraph">
<p>The downside of high-bandwidth mode is that your node is likely to
receive redundant information from each high-bandwidth peer it chooses.
As of this writing, Bitcoin Core currently only asks three peers to use
high-bandwidth mode (and it tries to choose peers that have a history of
quickly announcing blocks).</p>
</div>
</dd>
</dl>
</div>
<div id="bip152_illustration" class="imageblock">
<div class="content">
<img src="images/mbc3_1002.png" alt="BIP152">
</div>
<div class="title">Figure 2. BIP152 modes compared (from BIP152).  The shaded bar indicates the time it takes the node to validate the block.</div>
</div>
<div class="paragraph">
<p>The names of the two methods (which are taken from BIP152) can be a bit
confusing.  Low-bandwidth mode saves bandwidth by not sending blocks in
most cases.  High-bandwidth mode uses more bandwidth than low-bandwidth
mode but, in most cases, much less bandwidth than was used for block
relay before compact blocks were implemented.</p>
</div>
</div>
<div class="sect2">
<h3 id="_private_block_relay_networks">Private Block Relay Networks</h3>
<div class="paragraph">
<p>Although compact blocks go a long way toward minimizing the time it
takes for blocks to propagate across the network,
it&#8217;s possible to minimize latency further.  Unlike
compact blocks, though, the other solutions involve trade-offs that
make them unavailable or unsuitable for the public P2P relay network.
For that reason, there has been experimentation with private relay
networks for blocks.</p>
</div>
<div class="paragraph">
<p>One simple technique is to preselect a route between endpoints.  For
example, a relay network with servers running in datacenters near major
trans-oceanic fiber optic lines might be able to forward new blocks
faster than waiting for the block to arrive at the node run by some home
user many kilometers away from the fiber optic line.</p>
</div>
<div class="paragraph">
<p>Another, more complex technique, is Forward Error Correction (FEC).
This allows a compact block message to be split into several parts, with
each part having extra data appended.  If any of the parts isn&#8217;t
received, that part can be reconstructed from the parts that are
received.  Depending on the settings, up to several parts may be
reconstructed if they are lost.</p>
</div>
<div class="paragraph">
<p>FEC avoids the problem of a compact block (or some parts of it) not
arriving due to problems with the underlying network connection.
Those problems frequently occur but we don&#8217;t often notice them
because we mostly use protocols that automatically re-request the
missing data.  However, requesting missing data triples the time to
receive it.  For example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Alice sends some data to Bob.</p>
</li>
<li>
<p>Bob doesn&#8217;t receive the data (or it is damaged).   Bob re-requests
the data from Alice.</p>
</li>
<li>
<p>Alice sends the data again.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A third technique is to assume all nodes receiving the data have
almost all of the same transactions in their mempool, so they can all
accept the same compact block.  That not only saves us time computing
a compact block at each hop, but it means that each hop can simply
relay the FEC packets to the next hop even before validating them.</p>
</div>
<div class="paragraph">
<p>The trade-off for each of the preceding methods is that they work well with
centralization but not in a decentralized network where individual nodes
can&#8217;t trust other nodes.  Servers in datacenters cost money and can
often be accessed by operators of the datacenter, making them less
trustworthy than a secure home computer.  Relaying data before
validating makes it easy to waste bandwidth, so it can only reasonably
be used on a private network where there&#8217;s some level of trust and
accountability between parties.</p>
</div>
<div class="paragraph">
<p>The original
<a href="https://oreil.ly/30ZKi">Bitcoin Relay Network</a> was created by
developer Matt Corallo in 2015 to enable fast synchronization of
blocks between miners with very low latency. The network consisted of
several virtual private servers (VPSes) hosted on
infrastructure around the world and served to connect the majority of
miners and mining pools.</p>
</div>
<div class="paragraph">
<p>The original Bitcoin Relay Network was replaced in 2016
with the introduction of the <em>Fast Internet Bitcoin Relay Engine</em> or
<a href="https://bitcoinfibre.org"><em>FIBRE</em></a>, also created by developer Matt
Corallo. FIBRE is software that allows operating a UDP-based relay network that relays blocks within a
network of nodes. FIBRE implements FEC and the <em>compact block</em> optimization to
further reduce the amount of data transmitted and the network latency.</p>
</div>
</div>
<div class="sect2">
<h3 id="_network_discovery">Network Discovery</h3>
<div class="paragraph">
<p>When a new node boots up, it must discover other
Bitcoin nodes on the network in order to participate. To start this
process, a new node must discover at least one existing node on the
network and connect to it. The geographic location of other nodes is
irrelevant; the Bitcoin network topology is not geographically defined.
Therefore, any existing Bitcoin nodes can be selected at random.</p>
</div>
<div class="paragraph">
<p>To connect to a known peer, nodes establish a TCP connection, usually to
port 8333 (the port generally known as the one used by Bitcoin), or an
alternative port if one is provided. Upon establishing a connection, the
node will start a "handshake" (see <a href="#network_handshake">The initial handshake between peers.</a>) by
transmitting a  version message, which contains basic identifying
information, including:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Version</dt>
<dd>
<p>The Bitcoin P2P protocol version the client "speaks" (e.g., 70002)</p>
</dd>
<dt class="hdlist1">nLocalServices</dt>
<dd>
<p>A list of local services supported by the node</p>
</dd>
<dt class="hdlist1">nTime</dt>
<dd>
<p>The current time</p>
</dd>
<dt class="hdlist1">addrYou</dt>
<dd>
<p>The IP address of the remote node, as seen from this node</p>
</dd>
<dt class="hdlist1">addrMe</dt>
<dd>
<p>The IP address of the local node, as discovered by the local node</p>
</dd>
<dt class="hdlist1">subver</dt>
<dd>
<p>A subversion showing the type of software running on this node (e.g., <span class="keep-together">/Satoshi:0.9.2.1/</span>)</p>
</dd>
<dt class="hdlist1">BestHeight</dt>
<dd>
<p>The block height of this node&#8217;s blockchain</p>
</dd>
<dt class="hdlist1">fRelay</dt>
<dd>
<p>A field added by BIP37 for requesting not to receive unconfirmed transactions</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The version message is always the first message sent by any peer to
another peer. The local peer receiving a version message will examine
the remote peer&#8217;s reported Version and decide if the remote peer is
compatible. If the remote peer is compatible, the local peer will
acknowledge the version message and establish a connection by sending
a verack.</p>
</div>
<div class="paragraph less_space pagebreak-before">
<p>How does a new node find peers? The first method is to query DNS using a
number of <em>DNS seeds</em>, which are DNS servers that provide a list of IP
addresses of Bitcoin nodes. Some of those DNS seeds provide a static
list of IP addresses of stable Bitcoin listening nodes. Some of the DNS
seeds are custom implementations of BIND (Berkeley Internet Name Daemon)
that return a random subset from a list of Bitcoin node addresses
collected by a crawler or a long-running Bitcoin node.  The Bitcoin Core
client contains the names of several different DNS seeds. The diversity of
ownership and diversity of implementation of the different DNS seeds
offers a high level of reliability for the initial bootstrapping
process. In the Bitcoin Core client, the option to use the DNS seeds is
controlled by the option switch -dnsseed (set to 1 by default, to use
the DNS seed).</p>
</div>
<div class="paragraph">
<p>Alternatively, a bootstrapping node that knows nothing of the network
must be given the IP address of at least one Bitcoin node, after which
it can establish connections through further introductions. The
command-line argument -seednode can be used to connect to one node
just for introductions using it as a seed. After the initial seed node
is used to form introductions, the client will disconnect from it and
use the newly discovered peers.</p>
</div>
<div id="network_handshake" class="imageblock">
<div class="content">
<img src="images/mbc3_1003.png" alt="NetworkHandshake">
</div>
<div class="title">Figure 3. The initial handshake between peers.</div>
</div>
<div class="paragraph">
<p>Once one or more connections are established, the new node will send an
addr message containing its own IP address to its neighbors. The
neighbors will, in turn, forward the addr message to their neighbors,
ensuring that the newly connected node becomes well known and better
connected. Additionally, the newly connected node can send getaddr to
its neighbors, asking them to return a list of IP addresses of other
peers. That way, a node can find peers to connect to and advertise its
existence on the network for other nodes to find it.
<a href="#address_propagation">Address propagation and discovery.</a> shows the address discovery protocol.</p>
</div>
<div id="address_propagation" class="imageblock">
<div class="content">
<img src="images/mbc3_1004.png" alt="AddressPropagation">
</div>
<div class="title">Figure 4. Address propagation and discovery.</div>
</div>
<div class="paragraph">
<p>A node must connect to a few different peers in order to establish
diverse paths into the Bitcoin network. Paths are not reliable—nodes
come and go—and so the node must continue to discover new nodes as it
loses old connections as well as assist other nodes when they bootstrap.
Only one connection is needed to bootstrap because the first node can
offer introductions to its peer nodes and those peers can offer further
introductions. It&#8217;s also unnecessary and wasteful of network resources
to connect to more than a handful of nodes. After bootstrapping, a node
will remember its most recent successful peer connections so if it
is rebooted, it can quickly reestablish connections with its former peer
network. If none of the former peers respond to its connection request,
the node can use the seed nodes to bootstrap again.</p>
</div>
<div class="paragraph">
<p>On a node running the Bitcoin Core client, you can list the peer
connections with the command getpeerinfo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ bitcoin-cli getpeerinfo</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">[
  {
    "id": 0,
    "addr": "82.64.116.5:8333",
    "addrbind": "192.168.0.133:50564",
    "addrlocal": "72.253.6.11:50564",
    "network": "ipv4",
    "services": "0000000000000409",
    "servicesnames": [
      "NETWORK",
      "WITNESS",
      "NETWORK_LIMITED"
    ],
    "lastsend": 1683829947,
    "lastrecv": 1683829989,
    "last_transaction": 0,
    "last_block": 1683829989,
    "bytessent": 3558504,
    "bytesrecv": 6016081,
    "conntime": 1683647841,
    "timeoffset": 0,
    "pingtime": 0.204744,
    "minping": 0.20337,
    "version": 70016,
    "subver": "/Satoshi:24.0.1/",
    "inbound": false,
    "bip152_hb_to": true,
    "bip152_hb_from": false,
    "startingheight": 788954,
    "presynced_headers": -1,
    "synced_headers": 789281,
    "synced_blocks": 789281,
    "inflight": [
    ],
    "relaytxes": false,
    "minfeefilter": 0.00000000,
    "addr_relay_enabled": false,
    "addr_processed": 0,
    "addr_rate_limited": 0,
    "permissions": [
    ],
    "bytessent_per_msg": {
      ...
    },
    "bytesrecv_per_msg": {
      ...
    },
    "connection_type": "block-relay-only"
  },
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>To override the automatic management of peers and to specify a list of
IP addresses, users can provide the option -connect=&lt;IPAddress&gt; and
specify one or more IP addresses. If this option is used, the node will
only connect to the selected IP addresses instead of discovering and
maintaining the peer connections automatically.</p>
</div>
<div class="paragraph">
<p>If there is no traffic on a connection, nodes will periodically send a
message to maintain the connection. If a node has not communicated on a
connection for too long, it is assumed to be disconnected
and a new peer will be sought. Thus, the network dynamically adjusts to
transient nodes and network problems and can organically grow and
shrink as needed without any central control.</p>
</div>
</div>
<div class="sect2">
<h3 id="_full_nodes">Full Nodes</h3>
<div class="paragraph">
<p>Full nodes are nodes that verify every transaction in every block on the
valid blockchain with the most proof of work.</p>
</div>
<div class="paragraph">
<p>Full nodes
independently process every block, starting after the very first
block (genesis block) and building up to the latest known block in the
network. A full node can independently and authoritatively
verify any transaction.
The full node relies on the network to
receive updates about new blocks of transactions, which it then verifies
and incorporates into its local view of which scripts control which
bitcoins, called the set of <em>unspent transaction outputs</em> (UTXOs).</p>
</div>
<div class="paragraph">
<p>Running a full node gives
you the pure Bitcoin experience: independent verification of all
transactions without the need to rely on, or trust, any other systems.</p>
</div>
<div class="paragraph">
<p>There are a few alternative implementations of
full nodes, built using different programming
languages and software architectures, or which made different design
decisions. However, the most common
implementation is Bitcoin Core.
More than 95% of full nodes on the Bitcoin network run
various versions of Bitcoin Core. It is identified as "Satoshi" in the
subversion string sent in the version message and shown by the
command getpeerinfo as we saw earlier; for example, <span class="keep-together">/Satoshi:24.0.1/</span>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exchanging_inventory">Exchanging "Inventory"</h3>
<div class="paragraph">
<p>The first thing a full
node will do once it connects to peers is try to construct a complete
chain of block headers. If it is a brand-new node and has no blockchain at all, it
only knows one block, the genesis block, which is statically embedded in
the client software. Starting after block #0 (the genesis block), the new
node will have to download hundreds of thousands of blocks to
synchronize with the network and reestablish the full blockchain.</p>
</div>
<div class="paragraph">
<p>The
process of syncing the blockchain starts with the version message
because that contains BestHeight, a node&#8217;s current blockchain height
(number of blocks). A node will see the version messages from its
peers, know how many blocks they each have, and be able to compare to
how many blocks it has in its own blockchain. Peered nodes will exchange
a getheaders message that contains the hash of the top
block on their local blockchain. One of the peers will be able to
identify the received hash as belonging to a block that is not at the
top, but rather belongs to an older block, thus deducing that its own
local blockchain is longer than the remote node&#8217;s blockchain.</p>
</div>
<div class="paragraph">
<p>The peer that has the longer blockchain has more blocks than the other
node and can identify which headers the other node needs in order to
"catch up." It will identify the first 2,000 headers to share using a
headers message.  The node will keep requesting additional headers
until it has received one for every block the remote peer claims to
have.</p>
</div>
<div class="paragraph">
<p>In parallel, the node will begin requesting the blocks for each header
it previously received using a getdata message.  The node will request
different blocks from each of its selected peers, which allows it to drop
connections to peers that are significantly slower than the average in
order to find newer (and possibly faster) peers.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume, for example, that a node only has the genesis block. It
will then receive a headers message from its peers containing the headers
of the next 2,000 blocks in the chain. It will start requesting blocks
from all of its connected peers, keeping a queue of up to 1,024 blocks.
Blocks need to be validated in order, so if the oldest block in the
queue&#8212;&#8203;the block the node next needs to validate&#8212;&#8203;hasn&#8217;t been received
yet, the node drops the connection to the peer that was supposed to
provide that block.  It then finds a new peer that may be able to
provide one block before all of the node&#8217;s other peers are able to
provide 1,023 blocks.</p>
</div>
<div class="paragraph">
<p>As each block is received, it is added to the
blockchain, as we will see in <a href="#blockchain">[blockchain]</a>. As the local blockchain is
gradually built up, more blocks are requested and received, and the
process continues until the node catches up to the rest of the network.</p>
</div>
<div class="paragraph">
<p>This process of comparing the local blockchain with the peers and
retrieving any missing blocks happens any time a node has been offline for
an extended period of time.</p>
</div>
</div>
<div class="sect2">
<h3 id="spv_nodes">Lightweight Clients</h3>
<div class="paragraph">
<p>Many Bitcoin clients are designed to run on space- and
power-constrained devices, such as smartphones, tablets, or embedded
systems. For such devices, a <em>simplified payment verification</em> (SPV)
method is used to allow them to operate without validating the full
blockchain. These types of clients are called lightweight
clients.</p>
</div>
<div class="paragraph">
<p>Lightweight clients download only the block headers and do not download the
transactions included in each block. The resulting chain of headers,
without transactions, is about 10,000 times smaller than the full blockchain.
Lightweight clients cannot construct a full picture of all the UTXOs that are
available for spending because they do not know about all the
transactions on the network. Instead, they verify transactions using a
slightly different method that relies on peers to provide partial views
of relevant parts of the blockchain on demand.</p>
</div>
<div class="paragraph">
<p>As an analogy, a full node is like a tourist in a strange city, equipped
with a detailed map of every street and every address. By comparison, a
lightweight client is like a tourist in a strange city asking random strangers for
turn-by-turn directions while knowing only one main avenue. Although
both tourists can verify the existence of a street by visiting it, the
tourist without a map doesn&#8217;t know what lies down any of the side
streets and doesn&#8217;t know what other streets exist. Positioned in front
of 23 Church Street, the tourist without a map cannot know if there are
a dozen other <span class="keep-together">"23 Church</span> Street" addresses in the city and whether this
is the right one. The mapless tourist&#8217;s best chance is to ask enough
people and hope some of them are not trying to mug him.</p>
</div>
<div class="paragraph">
<p>Lightweight clients verify transactions by reference to their <em>depth</em> in the blockchain. Whereas a full node will construct a fully verified chain of thousands of blocks and millions of transactions reaching down the blockchain (back in time) all the way to the genesis block, a lightweight client will verify the proof of work of all blocks (but not whether the blocks and all of their transactions are valid) and link that chain to the transaction of interest.</p>
</div>
<div class="paragraph">
<p>For example, when examining a transaction in block 800,000, a full node
verifies all 800,000 blocks down to the genesis block and builds a full
database of UTXOs, establishing the validity of the transaction by
confirming that the transaction exists and its output remains unspent. A lightweight client can
only verify that the transaction exists. The client establishes a link
between the transaction and the block that contains it, using a <em>merkle
path</em> (see <a href="#merkle_trees">[merkle_trees]</a>). Then, the lightweight client waits until it sees the
six blocks 800,001 through 800,006 piled on top of the block containing
the transaction and verifies it by establishing its depth under blocks
800,006 to 800,001. The fact that other nodes on the network accepted
block 800,000 and that miners did the necessary work to produce six more blocks
on top of it is proof, by proxy, that the transaction actually exists.</p>
</div>
<div class="paragraph">
<p>A lightweight client cannot normally be persuaded that a transaction exists in a block
when the transaction does not in fact exist. The lightweight client establishes
the existence of a transaction in a block by requesting a merkle path
proof and by validating the proof of work in the chain of blocks.
However, a transaction&#8217;s existence can be "hidden" from a lightweight client. A
lightweight client can definitely verify that a transaction exists but cannot
verify that a transaction, such as a double-spend of the same UTXO,
doesn&#8217;t exist because it doesn&#8217;t have a record of all transactions. This
vulnerability can be used in a denial-of-service attack or for a
double-spending attack against lightweight clients. To defend against this, a lightweight
client needs to connect randomly to several clients to increase the
probability that it is in contact with at least one honest node. This
need to randomly connect means that lightweight clients also are vulnerable to
network partitioning attacks or Sybil attacks, where they are connected
to fake nodes or fake networks and do not have access to honest nodes or
the real Bitcoin network.</p>
</div>
<div class="paragraph">
<p>For many practical purposes, well-connected lightweight clients are secure enough,
striking a balance between resource needs, practicality, and security.
For infallible security, however, nothing beats running a full
node.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>A full node verifies a transaction by checking the entire chain of
thousands of blocks below it in order to guarantee that the UTXO exists
and is not spent, whereas a lightweight client only proves that a transaction
exists and checks that the block containing that transaction is
buried by a handful of blocks above it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To get the block headers it needs to verify a transaction is part of the
chain, lightweight clients use a getheaders message.
The responding peer will send up to 2,000 block headers
using a single headers message.  See the illustration in
<a href="#spv_synchronization">Lightweight client synchronizing the block headers.</a>.</p>
</div>
<div id="spv_synchronization" class="imageblock">
<div class="content">
<img src="images/mbc3_1005.png" alt="Header synchronization">
</div>
<div class="title">Figure 5. Lightweight client synchronizing the block headers.</div>
</div>
<div class="paragraph">
<p>Block headers allow a lightweight client to verify that any individual block
belongs to the blockchain with the most proof of work, but they don&#8217;t
tell the client which blocks contain transactions that are interesting to
its wallet.  The client could download every block and check, but that
would use a large fraction of the resources it would take to run a full
node, so developers have looked for other ways to solve the problem.</p>
</div>
<div class="paragraph">
<p>Shortly after the introduction of lightweight clients, Bitcoin
developers added a feature called <em>bloom filters</em> in an attempt to
reduce the bandwidth that lightweight clients needed to use to learn about their
incoming and outgoing transactions.
Bloom filters allow lightweight clients to receive a subset of
the transactions without directly revealing precisely which addresses they are
interested in, through a filtering mechanism that uses probabilities
rather than fixed patterns.</p>
</div>
</div>
<div class="sect2">
<h3 id="bloom_filters">Bloom Filters</h3>
<div class="paragraph">
<p>A bloom filter is a probabilistic search filter, a way
to describe a desired pattern without specifying it exactly. Bloom
filters offer an efficient way to express a search pattern while
protecting privacy. They are used by lightweight clients to ask their peers for
transactions matching a specific pattern without revealing exactly
which addresses, keys, or transactions they are searching for.</p>
</div>
<div class="paragraph">
<p>In our previous analogy, a tourist without a map is asking for
directions to a specific address, "23 Church St." If they ask a stranger
for directions to this street, they inadvertently reveal their
destination. A bloom filter is like asking, "Are there any streets in
this neighborhood whose name ends in R-C-H?" A question like that
reveals slightly less about the desired destination than asking for "23
Church St." Using this technique, a tourist could specify the desired
address in more detail such as "ending in U-R-C-H" or less detail such as
"ending in H." By varying the precision of the search, the tourist
reveals more or less information at the expense of getting more or less
specific results. If they ask for a less specific pattern, they get a lot
more possible addresses and better privacy, but many of the results are
irrelevant. If they ask for a very specific pattern, they get fewer
results but lose privacy.</p>
</div>
<div class="paragraph">
<p>Bloom filters serve this function by allowing a lightweight client to specify a
search pattern for transactions that can be tuned toward precision or
privacy. A more specific bloom filter will produce accurate results, but
at the expense of revealing what patterns the lightweight client is interested in,
thus revealing the addresses owned by the user&#8217;s wallet. A less specific
bloom filter will produce more data about more transactions, many
irrelevant to the client, but will allow the client to maintain better
privacy.</p>
</div>
<div class="sect3">
<h4 id="_how_bloom_filters_work">How Bloom Filters Work</h4>
<div class="paragraph">
<p>Bloom filters are implemented as a variable-size array of N binary
digits (a bit field) and a variable number of M hash functions. The hash
functions are designed to always produce an output that is between 1 and
N, corresponding to the array of binary digits. The hash functions are
generated deterministically, so that any client implementing a bloom
filter will always use the same hash functions and get the same results
for a specific input. By choosing different length (N) bloom filters and
a different number (M) of hash functions, the bloom filter can be tuned,
varying the level of accuracy and therefore privacy.</p>
</div>
<div class="paragraph">
<p>In <a href="#bloom1">An example of a simplistic bloom filter, with a 16-bit field and three hash functions.</a>, we use a very small array of 16 bits and a set of three
hash functions to demonstrate how bloom filters work.</p>
</div>
<div id="bloom1" class="imageblock">
<div class="content">
<img src="images/mbc3_1006.png" alt="Bloom1">
</div>
<div class="title">Figure 6. An example of a simplistic bloom filter, with a 16-bit field and three hash functions.</div>
</div>
<div class="paragraph">
<p>The bloom filter is initialized so that the array of bits is all zeros.
To add a pattern to the bloom filter, the pattern is hashed by each hash
function in turn. Applying the first hash function to the input results
in a number between 1 and N. The corresponding bit in the array (indexed
from 1 to N) is found and set to 1, thereby recording the output of
the hash function. Then, the next hash function is used to set another
bit and so on. Once all M hash functions have been applied, the search
pattern will be "recorded" in the bloom filter as M bits that have been
changed from 0 to 1.</p>
</div>
<div class="paragraph">
<p><a href="#bloom2">Adding a pattern "A" to our simple bloom filter.</a> is an example of adding a pattern "A" to the simple bloom filter shown in <a href="#bloom1">An example of a simplistic bloom filter, with a 16-bit field and three hash functions.</a>.</p>
</div>
<div class="paragraph">
<p>Adding a second pattern is as simple as repeating this process. The
pattern is hashed by each hash function in turn, and the result is
recorded by setting the bits to 1. Note that as a bloom filter is
filled with more patterns, a hash function result might coincide with a
bit that is already set to 1, in which case the bit is not changed. In
essence, as more patterns record on overlapping bits, the bloom filter
starts to become saturated with more bits set to 1 and the accuracy of
the filter decreases. This is why the filter is a probabilistic data
structure—it gets less accurate as more patterns are added. The accuracy
depends on the number of patterns added versus the size of the bit array
(N) and number of hash functions (M). A larger bit array and more hash
functions can record more patterns with higher accuracy. A smaller bit
array or fewer hash functions will record fewer patterns and produce
less accuracy.</p>
</div>
<div id="bloom2" class="imageblock">
<div class="content">
<img src="images/mbc3_1007.png" alt="Bloom2">
</div>
<div class="title">Figure 7. Adding a pattern "A" to our simple bloom filter.</div>
</div>
<div class="paragraph">
<p><a href="#bloom3">Adding a second pattern "B" to our simple bloom filter.</a> is an example of adding a second pattern "B" to the simple bloom filter.</p>
</div>
<div id="bloom3" class="imageblock">
<div class="content">
<img src="images/mbc3_1008.png" alt="Bloom3">
</div>
<div class="title">Figure 8. Adding a second pattern "B" to our simple bloom filter.</div>
</div>
<div class="paragraph less_space pagebreak-before">
<p>To test if a pattern is part of a bloom filter, the pattern is hashed by
each hash function and the resulting bit pattern is tested against the
bit array. If all the bits indexed by the hash functions are set to 1,
then the pattern is <em>probably</em> recorded in the bloom filter. Because the
bits may be set because of overlap from multiple patterns, the answer is
not certain, but is rather probabilistic. In simple terms, a bloom
filter positive match is a "Maybe, yes."</p>
</div>
<div class="paragraph">
<p><a href="#bloom4">Testing the existence of pattern "X" in the bloom filter. The result is a probabilistic positive match, meaning "Maybe."</a> is an example of testing the existence of pattern "X" in the
simple bloom filter. The corresponding bits are set to 1, so the
pattern is probably a match.</p>
</div>
<div id="bloom4" class="imageblock">
<div class="content">
<img src="images/mbc3_1009.png" alt="Bloom4">
</div>
<div class="title">Figure 9. Testing the existence of pattern "X" in the bloom filter. The result is a probabilistic positive match, meaning "Maybe."</div>
</div>
<div class="paragraph">
<p>On the contrary, if a pattern is tested against the bloom filter and any
one of the bits is set to 0, this proves that the pattern was not
recorded in the bloom filter. A negative result is not a probability, it
is a certainty. In simple terms, a negative match on a bloom filter is a
"Definitely not!"</p>
</div>
<div class="paragraph">
<p><a href="#bloom5">Testing the existence of pattern "Y" in the bloom filter. The result is a definitive negative match, meaning "Definitely Not!"</a> is an example of testing the existence of pattern "Y" in the
simple bloom filter. One of the corresponding bits is set to 0, so the
pattern is definitely not a match.</p>
</div>
<div id="bloom5" class="imageblock">
<div class="content">
<img src="images/mbc3_1010.png" alt="mbc3 1010">
</div>
<div class="title">Figure 10. Testing the existence of pattern "Y" in the bloom filter. The result is a definitive negative match, meaning "Definitely Not!"</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_lightweight_clients_use_bloom_filters">How Lightweight Clients Use Bloom Filters</h4>
<div class="paragraph">
<p>Bloom filters are used to filter the transactions (and blocks containing
them) that a lightweight client receives from its peers, selecting only
transactions of interest to the lightweight client without revealing exactly which
addresses or keys it is interested in.</p>
</div>
<div class="paragraph">
<p>A lightweight client will initialize a bloom filter
as "empty"; in that state, the bloom filter will not match any patterns.
The lightweight client will then make a list of all the addresses, keys, and
hashes that it is interested in. It will do this by extracting the
public key hash, script hash, and transaction IDs from any UTXO
controlled by its wallet. The lightweight client then adds each of these to the
bloom filter so that the bloom filter will "match" if these patterns
are present in a transaction, without revealing the patterns themselves.</p>
</div>
<div class="paragraph">
<p>The lightweight client will then send a
filterload message to the peer containing the bloom filter to use on
the connection. On the peer, bloom filters are checked against each
incoming transaction. The full node checks several parts of the
transaction against the bloom filter, looking for a match including:</p>
</div>
<ul>
<li>The transaction ID</li>
<li>The data components from the scripts of each of the transaction outputs (every key and hash in the script)</li>
<li class="less_space pagebreak-before">Each of the transaction inputs</li>
<li>Each of the input signature data components (or witness scripts)</li>
</ul>
<div class="paragraph">
<p>By checking against all these components, bloom filters can be used to
match public key hashes, scripts, OP_RETURN values, public keys in
signatures, or any future component of a smart contract or complex
script.</p>
</div>
<div class="paragraph">
<p>After a filter is established, the peer will then test each
transaction&#8217;s outputs against the bloom filter. Only transactions that
match the filter are sent to the client.</p>
</div>
<div class="paragraph">
<p>In response to a getdata message from the client, peers will send a
merkleblock message that contains only block headers for blocks
matching the filter and a merkle path (see <a href="#merkle_trees">[merkle_trees]</a>) for each
matching transaction. The peer will then also send tx messages
containing the transactions matched by the filter.</p>
</div>
<div class="paragraph">
<p>As the full node sends transactions to the lightweight client, the lightweight client
discards any false positives and uses the correctly matched transactions
to update its UTXO set and wallet balance. As it updates its own view of
the UTXO set, it also modifies the bloom filter to match any future
transactions referencing the UTXO it just found. The full node then uses
the new bloom filter to match new transactions and the whole process
repeats.</p>
</div>
<div class="paragraph">
<p>The client setting the bloom filter can interactively add patterns to the
filter by sending a filteradd message. To clear the bloom filter, the
client can send a filterclear message. Because it is not possible to
remove a pattern from a bloom filter, a client has to clear and resend a
new bloom filter if a pattern is no longer desired.</p>
</div>
<div class="paragraph">
<p>The network protocol and bloom filter mechanism for lightweight clients is defined
in BIP37.</p>
</div>
<div class="paragraph">
<p>Unfortunately, after the deployment of bloom filters, it became clear
that they didn&#8217;t offer very much privacy.  A full node receiving a bloom
filter from a peer could apply that filter to the entire blockchain to
find all of the client&#8217;s transactions (plus false positives).  It could
then look for patterns and relationships between the transactions.
Randomly selected false positive transactions would be unlikely to have
a parent-child relationship from output to input, but transactions from
the user&#8217;s wallet would be very likely to have that relationship.  If
all of the related transactions have certain characteristics, such as
at least one P2PKH output, then transactions without that characteristic
can be assumed not to belong to the wallet.</p>
</div>
<div class="paragraph">
<p>It was also discovered that specially constructed filters could force
the full nodes that processed them to perform a large amount of work,
which could lead to denial-of-service attacks.</p>
</div>
<div class="paragraph">
<p>For both of those reasons, Bitcoin Core eventually limited support for
bloom filters to only clients on IP addresses that were explicitly
allowed by the node operator.  This meant that an alternative method for
helping lightweight clients find their transactions was needed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compact_block_filters">Compact Block Filters</h3>
<div class="paragraph">
<p>An idea was posted to the Bitcoin-Dev mailing list by an anonymous
developer in 2016 of reversing the bloom filter process.  With a BIP37
bloom filter, each client hashes their addresses to create a bloom
filter and nodes hash parts of each transaction to attempt to match
that filter.  In the new proposal, nodes hash parts of each transaction
in a block to create a bloom filter and clients hash their addresses to
attempt to match that filter.  If a client finds a match, they download
the entire block.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Despite the similarities in names, BIP152 <em>compact blocks</em> and
BIP157/158 <em>compact block filters</em> are unrelated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This allows nodes to create a single filter for every block, which they
can save to disk and serve over and over, eliminating the
denial-of-service vulnerabilities with BIP37.  Clients don&#8217;t give full
nodes any information about their past or future addresses.  They only
download blocks, which may contain thousands of transactions that
weren&#8217;t created by the client.  They can even download each matching
block from a different peer, making it harder for full nodes to connect
transactions belonging to a single client across multiple blocks.</p>
</div>
<div class="paragraph">
<p>This idea for server-generated filters doesn&#8217;t offer perfect privacy;
it still places some costs on full nodes (and it does require lightweight
clients to use more bandwidth for the block download), and the filters can
only be used for confirmed transactions (not unconfirmed transactions). However,
it is much more private and reliable than BIP37 client-requested
bloom filters.</p>
</div>
<div class="paragraph">
<p>After the description of the original idea based on bloom filters,
developers realized there was a better data structure for
server-generated filters, called Golomb-Rice Coded Sets (GCS).</p>
</div>
<div class="sect3">
<h4 id="_golomb_rice_coded_sets_gcs">Golomb-Rice Coded Sets (GCS)</h4>
<div class="paragraph">
<p>Imagine that Alice wants to send a list of numbers to Bob.  The simple
way to do that is to just send him the entire list of numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>849
653
476
900
379</pre>
</div>
</div>
<div class="paragraph">
<p>But there&#8217;s a more efficient way.  First, Alice puts the list in
numerical order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>379
476
653
849
900</pre>
</div>
</div>
<div class="paragraph">
<p>Then, Alice sends the first number.  For the remaining numbers, she
sends the difference between that number and the preceding number.  For
example, for the second number, she sends 97 (476 – 379); for the third
number, she sends 177 (653 – 476); and so on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>379
97
177
196
51</pre>
</div>
</div>
<div class="paragraph">
<p>We can see that the differences between two numbers in an ordered list
produces numbers that are shorter than the original numbers.  Upon
receiving this list, Bob can reconstruct the original list by simply
adding each number with its predecessor.  That means we save space
without losing any information, which is called <em>lossless encoding</em>.</p>
</div>
<div class="paragraph">
<p>If we randomly select numbers within a fixed range of values, then the
more numbers we select, the smaller the average (mean) size of the
differences.  That means the amount of data we need to transfer doesn&#8217;t
increase as fast as the length of our list increases (up to a point).</p>
</div>
<div class="paragraph">
<p>Even more usefully, the length of the randomly selected numbers in a
list of differences is naturally biased toward smaller lengths.
Consider selecting two random numbers from 1 to 6; this is the same
as rolling two dice.  There are 36 distinct combinations of two dice:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 6</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Let&#8217;s find the difference between the larger of the numbers and the
smaller of the numbers:</p>
</div>
<table class="tableblock frame-all grid-all stretch less_space pagebreak-before">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If we count the frequency of each difference occurring, we see that the
small differences are much more likely to occur than the large
differences:</p>
</div>
<table>

<thead>
<tr>
<th>Difference</th>
<th>Occurrences</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>0</p></td>
<td><p>6</p></td>
</tr>
<tr>
<td><p>1</p></td>
<td><p>10</p></td>
</tr>
<tr>
<td><p>2</p></td>
<td><p>8</p></td>
</tr>
<tr>
<td><p>3</p></td>
<td><p>6</p></td>
</tr>
<tr>
<td><p>4</p></td>
<td><p>4</p></td>
</tr>
<tr>
<td><p>5</p></td>
<td><p>2</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If we know that we might need to store large numbers (because large
differences can happen, even if they are rare), but we&#8217;ll most often need
to store small numbers, we can encode each number using a system that
uses less space for small numbers and extra space for large numbers.
On average, that system will perform better than using the same amount
of space for every number.</p>
</div>
<div class="paragraph">
<p>Golomb coding provides that facility.  Rice coding is a subset of Golomb
coding that&#8217;s more convenient to use in some situations, including the
application of Bitcoin block filters.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_data_to_include_in_a_block_filter">What Data to Include in a Block Filter</h4>
<div class="paragraph">
<p>Our primary goal is to allow wallets to learn whether a block contains a
transaction affecting that wallet.  For a wallet to be effective, it
needs to learn two types of information:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">When it has received money</dt>
<dd>
<p>Specifically, when a transaction
   output contains a script that the wallet controls (such as by
   controlling the authorized private key)</p>
</dd>
<dt class="hdlist1">When it has spent money</dt>
<dd>
<p>Specifically, when a transaction input
   references a previous transaction output that the wallet controlled</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A secondary goal during the design of compact block filters was to allow
the wallet receiving the filter to verify that it received an accurate
filter from a peer.  For example, if the wallet downloaded the block
from which the filter was created, the wallet could generate its own
filter.  It could then compare its filter to the peer&#8217;s filter and
verify that they were identical, proving the peer had generated an
accurate filter.</p>
</div>
<div class="paragraph">
<p>For both the primary and secondary goals to be met, a filter would need
to reference two types of information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The script for every output in every transaction in a block</p>
</li>
<li>
<p>The outpoint for every input in every transaction in a block</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An early design for compact block filters included both of those pieces
of information, but it was realized there was a more efficient way
to accomplish the primary goal if we sacrificed the secondary goal.  In
the new design, a block filter would still reference two types of
information, but they&#8217;d be more closely related:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As before, the script for every output in every transaction in a
block.</p>
</li>
<li>
<p>In a change, it would also reference the script of the output
referenced by the outpoint for every input in every transaction in a
block.  In other words, the output script being spent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This had several advantages.  First, it meant that wallets didn&#8217;t need
to track outpoints; they could instead just scan for the
output scripts to which they expected to receive money. Second, any time a
later transaction in a block spends the output of an earlier
transaction in the same block, they&#8217;ll both reference the same
output script.  More than one reference to the same output script is
redundant in a compact block filter, so the redundant copies can be
removed, shrinking the size of the filters.</p>
</div>
<div class="paragraph">
<p>When full nodes validate a block, they need access to the output scripts
for both the current transaction outputs in a block and the transaction
outputs from previous blocks that are being referenced in inputs, so
they&#8217;re able to build compact block filters in this simplified model.
But a block itself doesn&#8217;t include the output scripts from transactions
included in previous blocks, so there&#8217;s no convenient way for a client
to verify a block filter was built correctly.  However, there is an
alternative that can help a client detect if a peer is lying to it:
obtaining the same filter from multiple peers.</p>
</div>
</div>
<div class="sect3">
<h4 id="_downloading_block_filters_from_multiple_peers">Downloading Block Filters from Multiple Peers</h4>
<div class="paragraph">
<p>A peer can provide a wallet with an inaccurate filter.  There are two ways
to create an inaccurate filter.  The peer can create a filter that
references transactions that don&#8217;t actually appear in the associated
block (a false positive).  Alternatively, the peer can create a filter
that doesn&#8217;t reference transactions that do actually appear in the
associated block (a false negative).</p>
</div>
<div class="paragraph">
<p>The first protection against an inaccurate filter is for a client to
obtain a filter from multiple peers.  The BIP157 protocol allows a
client to download just a short 32-byte commitment to a filter to
determine whether each peer is advertising the same filter as all of the
client&#8217;s other peers.  That minimizes the amount of bandwidth the client
must expend to query many different peers for their filters, if all of
those peers agree.</p>
</div>
<div class="paragraph">
<p>If two or more different peers have different filters for the same
block, the client can download all of them.  It can then also download
the associated block.  If the block contains any transaction related to
the wallet that is not part of one of the filters, then the wallet can
be sure that whichever peer created that filter was
inaccurate&#8212;&#8203;Golomb-Rice Coded Sets will always include a
potential match.</p>
</div>
<div class="paragraph">
<p>Alternatively, if the block doesn&#8217;t contain a transaction that the
filter said might match the wallet, that isn&#8217;t proof that the filter was
inaccurate.  To minimize the size of a GCS, we allow a certain number of
false positives.  What the wallet can do is continue downloading
additional filters from the peer, either randomly or when they indicate
a match, and then track the client&#8217;s false positive rate.  If it
differs significantly from the false positive rate that filters were
designed to use, the wallet can stop using that peer.  In most cases,
the only consequence of the inaccurate filter is that the wallet uses
more bandwidth than expected.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reducing_bandwidth_with_lossy_encoding">Reducing Bandwidth with Lossy Encoding</h4>
<div class="paragraph">
<p>The data about the transactions in a block that we want to communicate
is an output script.  Output scripts vary in length and follow patterns,
which means the differences between them won&#8217;t be evenly distributed
like we want.  However, we&#8217;ve already seen in many places in this book
that we can use a hash function to create a commitment to some data and
also produce a value that looks like a randomly selected number.</p>
</div>
<div class="paragraph">
<p>In other places in this book, we&#8217;ve used a cryptographically secure hash
function that provides assurances about the strength of its commitment
and how indistinguishable from random its output is.  However, there are
faster and more configurable non-cryptographic hash functions, such as
the SipHash function we&#8217;ll use for compact block filters.</p>
</div>
<div class="paragraph">
<p>The details of the algorithm used are described in BIP158, but the gist
is that each output script is reduced to a 64-bit commitment using
SipHash and some arithmetic operations.  You can think of this as
taking a set of large numbers and truncating them to shorter numbers, a
process that loses data (so it&#8217;s called <em>lossy encoding</em>).  By losing
some information, we don&#8217;t need to store as much information later,
which saves space.  In this case, we go from a typical output script
that&#8217;s 160 bits or longer down to just 64 bits.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_compact_block_filters">Using Compact Block Filters</h4>
<div class="paragraph">
<p>The 64-bit values for every commitment to an output script in a block are
sorted, duplicate entries are removed, and the GCS is constructed by
finding the differences (deltas) between each entry.  That compact block
filter is then distributed by peers to their clients (such as wallets).</p>
</div>
<div class="paragraph">
<p>A client uses the deltas to reconstruct the original commitments.  The
client, such as a wallet, also takes all the output scripts it is
monitoring for and generates commitments in the same way as BIP158.  It
checks whether any of its generated commitments match the commitments in
the filter.</p>
</div>
<div class="paragraph">
<p>Recall our example of the lossiness of compact block filters being
similar to truncating a number.  Imagine a client is looking for a block
that contains the number 123456 and that an accurate (but lossy)
compact block filter contains the number 1234.  When a client sees that
1234, it will download the associated block.</p>
</div>
<div class="paragraph">
<p>There&#8217;s a 100% guarantee that an accurate filter containing 1234 will
allow a client to learn about a block containing 123456, called a <em>true
positive</em>.  However, there&#8217;s also a chance that the block might contain
123400, 123401, or almost a hundred other entries that are not what the
client is looking for (in this example), called a <em>false positive</em>.</p>
</div>
<div class="paragraph">
<p>A 100% true positive match rate is great.  It means that a wallet can
depend on compact block filters to find every transaction affecting that
wallet.  A nonzero false positive rate means that the wallet will end
up downloading some blocks that don&#8217;t contain transactions interesting
to the wallet.  The main consequence of this is that the client will use
extra bandwidth, which is not a huge problem.  The actual
false positive rate for BIP158 compact block filters is very low, so
it&#8217;s not a major problem.  A false positive rate can also help improve a
client&#8217;s privacy, as it does with bloom filters, although anyone wanting
the best possible privacy should still use their own full node.</p>
</div>
<div class="paragraph">
<p>In the long term, some developers advocate for having blocks commit to
the filter for that block, with the most likely scheme having each
coinbase transaction commit to the filter for that block.  Full nodes
would calculate the filter for each block themselves and only accept a
block if it contained an accurate commitment.  That would allow a
lightweight client to download an 80-byte block header, a (usually)
small coinbase transaction, and the filter for that block to receive
strong evidence that the filter was accurate.</p>
</div>
</div>
</div>
<div class="sect2 less_space pagebreak-before">
<h3 id="_lightweight_clients_and_privacy">Lightweight Clients and Privacy</h3>
<div class="paragraph">
<p>Lightweight clients have weaker privacy than a full node. A full
node downloads all transactions and therefore reveals no information
about whether it is using some address in its wallet. A lightweight client
only downloads transactions that are related to its wallet in some way.</p>
</div>
<div class="paragraph">
<p>Bloom filters and compact block filters are ways to reduce the loss of privacy. Without them, a
lightweight client would have to explicitly list the addresses it was interested
in, creating a serious breach of privacy. However, even with
filters, an adversary monitoring the traffic of a lightweight client or
connected to it directly as a node in the P2P network may be able to collect enough
information over time to learn the addresses in the wallet of the lightweight
client.</p>
</div>
</div>
<div class="sect2">
<h3 id="_encrypted_and_authenticated_connections">Encrypted and Authenticated Connections</h3>
<div class="paragraph">
<p>Most new users of
Bitcoin assume that the network communications of a Bitcoin node are
encrypted. In fact, the original implementation of Bitcoin communicates
entirely in the clear, as does the modern implementation of Bitcoin Core
at the time of writing.</p>
</div>
<div class="paragraph">
<p>As a way to increase the privacy and security of the Bitcoin P2P
network, there is a solution that provides encryption of the
communications: <em>Tor transport</em>.</p>
</div>
<div class="paragraph">
<p>Tor, which
stands for <em>The Onion Routing network</em>, is a software project and
network that offers encryption and encapsulation of data through
randomized network paths that offer anonymity, untraceability, and
privacy.</p>
</div>
<div class="paragraph">
<p>Bitcoin Core offers several configuration options that allow you to run
a Bitcoin node with its traffic transported over the Tor network. In
addition, Bitcoin Core can also offer a Tor hidden service allowing
other Tor nodes to connect to your node directly over Tor.</p>
</div>
<div class="paragraph">
<p>As of Bitcoin Core version 0.12, a node will offer a hidden Tor service
automatically if it is able to connect to a local Tor service. If you
have Tor installed and the Bitcoin Core process runs as a user with
adequate permissions to access the Tor authentication cookie, it should
work automatically. Use the debug flag to turn on Bitcoin Core&#8217;s
debugging for the Tor service like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bitcoind --daemon --debug=tor</pre>
</div>
</div>
<div class="paragraph">
<p>You should see tor: ADD_ONION successful in the logs, indicating that
Bitcoin Core has added a hidden service to the Tor network.</p>
</div>
<div class="paragraph">
<p>You can find more instructions on running Bitcoin Core as a Tor hidden
service in the Bitcoin Core documentation (<em>docs/tor.md</em>) and various
online tutorials.</p>
</div>
</div>
<div class="sect2 less_space pagebreak-before">
<h3 id="mempool">Mempools and Orphan Pools</h3>
<div class="paragraph">
<p>Almost every node on the Bitcoin
network maintains a temporary list of unconfirmed transactions called
the <em>memory pool</em> (<em>mempool</em>). Nodes use this pool
to keep track of transactions that are known to the network but are not
yet included in the blockchain, called <em>unconfirmed transactions</em>.</p>
</div>
<div class="paragraph">
<p>As unconfirmed transactions are received and verified, they are added to the
mempool and relayed to the neighboring nodes to propagate on
the network.</p>
</div>
<div class="paragraph">
<p>Some node
implementations also maintain a separate pool of orphaned transactions.
If a transaction&#8217;s inputs refer to a transaction that is not yet known,
such as a missing parent, the orphan transaction will be stored
temporarily in the orphan pool until the parent transaction arrives.</p>
</div>
<div class="paragraph">
<p>When a transaction is added to the mempool, the orphan pool is
checked for any orphans that reference this transaction&#8217;s outputs (its
children). Any matching orphans are then validated. If valid, they are
removed from the orphan pool and added to the mempool,
completing the chain that started with the parent transaction. In light
of the newly added transaction, which is no longer an orphan, the
process is repeated recursively looking for any further descendants
until no more descendants are found. Through this process, the arrival
of a parent transaction triggers a cascade reconstruction of an entire
chain of interdependent transactions by reuniting the orphans with
their parents all the way down the chain.</p>
</div>
<div class="paragraph">
<p>Some implementations of Bitcoin also maintain a UTXO
database, which is the set of all unspent outputs on the
blockchain. This represents a different set of data from the mempool. Unlike the
mempool and orphan pools, the UTXO database
contains millions of entries of unspent transaction outputs,
everything that is unspent from all the way back to the genesis block.
The UTXO database is stored as a
table on persistent storage.</p>
</div>
<div class="paragraph">
<p>Whereas the mempool and orphan pools represent a single node&#8217;s local
perspective and might vary significantly from node to node depending
on when the node was started or restarted, the UTXO database represents
the emergent consensus of the network and therefore will not usually
vary between nodes.</p>
</div>
<div class="paragraph">
<p>Now that we have an understanding of many of the data types and
structures used by nodes and clients to send data across the Bitcoin
network, it&#8217;s time to look at the software that&#8217;s responsible for
keeping the network secure and operational.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-03-19 23:56:16 +0800
</div>
</div>
</body>
</html>