<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.22">
<title>Authorization and Authentication</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="c_authorization_authentication">Authorization and Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you receive bitcoins, you have to decide who will have permission
to spend them, called <em>authorization</em>.  You also have to decide how full
nodes will distinguish the authorized spenders from everyone else,
called <em>authentication</em>.  Your authorization instructions and the
spender proof of authentication will be checked by thousands of
independent full nodes, which all need to come to the same conclusion
that a spend was authorized and authenticated in order for the transaction
containing it to be valid.</p>
</div>
<div class="paragraph">
<p>The original description of Bitcoin used a public key for authorization.
Alice paid Bob by putting his public key in the output of a transaction.
Authentication came from Bob in the form of a signature that committed to a
spending transaction, such as from Bob to Carol.</p>
</div>
<div class="paragraph">
<p>The actual version of Bitcoin that was originally released provided a
more flexible mechanism for both authorization and authentication.
Improvements since then have only increased that flexibility.  In this
chapter, we&#8217;ll explore those features and see how they&#8217;re most commonly
used.</p>
</div>
<div class="sect2">
<h3 id="tx_script">Transaction Scripts and Script Language</h3>
<div class="paragraph">
<p>The original version of Bitcoin introduced a new
programming language called <em>Script</em>, a Forth-like stack-based
language.  Both the script placed in an output and the legacy
input script used in a spending transaction are written in this scripting
language.</p>
</div>
<div class="paragraph">
<p>Script is a very simple language.  It requires minimal processing and
cannot easily do many of the fancy things modern programming languages
can do.</p>
</div>
<div class="paragraph">
<p>When legacy transactions were the
most commonly used type of transaction, the majority of transactions processed
through the Bitcoin network had the form "Payment to Bob&#8217;s Bitcoin
address" and used a script called a pay to public key hash (P2PKH) script.
However, Bitcoin transactions are not limited to the "Payment to Bob&#8217;s
Bitcoin address" script. In fact, scripts can be written to express a
vast variety of complex conditions. In order to understand these more
complex scripts, we must first understand the basics of transaction
scripts and Script language.</p>
</div>
<div class="paragraph">
<p>In this section, we will demonstrate the basic components of the Bitcoin
transaction scripting language and show how it can be used to express
conditions for spending and how those conditions can be satisfied.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Bitcoin transaction validation is not based on
a static pattern but instead is achieved through the execution of a
scripting language. This language allows for a nearly infinite variety
of conditions to be expressed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_turing_incompleteness">Turing Incompleteness</h4>
<div class="paragraph">
<p>The Bitcoin transaction script language
contains many operators, but is deliberately limited in one important
way&#8212;&#8203;there are no loops or complex flow control capabilities other than
conditional flow control. This ensures that the language is not <em>Turing
Complete</em>, meaning that scripts have limited complexity and predictable
execution times. Script is not a general-purpose language.
These
limitations ensure that the language cannot be used to create an
infinite loop or other form of "logic bomb" that could be embedded in a
transaction in a way that causes a denial-of-service attack against the
Bitcoin network. Remember, every transaction is validated by every full
node on the Bitcoin network. A limited language prevents the transaction
validation mechanism from being used as a vulnerability.</p>
</div>
</div>
<div class="sect3">
<h4 id="_stateless_verification">Stateless Verification</h4>
<div class="paragraph">
<p>The Bitcoin transaction script language is
stateless, in that there is no state prior to execution of the script
or state saved after execution of the script. All the
information needed to execute a script is contained within the script
and the transaction executing the script.  A
script will predictably execute the same way on any system. If your
system verified a script, you can be sure that every other system in the
Bitcoin network will also verify the script, meaning that a valid
transaction is valid for everyone and everyone knows this. This
predictability of outcomes is an essential benefit of the Bitcoin
system.</p>
</div>
</div>
<div class="sect3">
<h4 id="tx_lock_unlock">Script Construction</h4>
<div class="paragraph">
<p>Bitcoin&#8217;s legacy transaction validation engine relies on two parts of scripts
to validate transactions: an output script and an input script.</p>
</div>
<div class="paragraph">
<p>An output script
specifies the conditions that must be met to spend the output in the
future, such as who is authorized to spend the output and how they will
be authenticated.</p>
</div>
<div class="paragraph">
<p>An input script is a script that satisfies the
conditions placed in an output script and allows the output
to be spent. Input scripts are part of every transaction input. Most
of the time in legacy transactions they contain a digital signature produced by the user&#8217;s
wallet from his or her private key, but not all input scripts
must contain signatures.</p>
</div>
<div class="paragraph">
<p>Every Bitcoin validating node will validate transactions by executing
the output and input scripts.  As we saw in
<a href="#c_transactions">[c_transactions]</a>, each input contains an outpoint that refers to a
previous transaction output.  The input also contains an input script.  The
validation software will copy the input script, retrieve the UTXO
referenced by the input, and copy the output script from that UTXO. The
input and output scripts are then executed together. The input is
valid if the input script satisfies the output script&#8217;s conditions
(see <a href="#script_exec">Separate execution of output and input scripts</a>). All the inputs are validated independently as
part of the overall validation of the transaction.</p>
</div>
<div class="paragraph">
<p>Note that the preceding steps involve making copies of all data.  The
original data in the previous output and current input is never changed.
In particular, the previous output is invariable and unaffected by
failed attempts to spend it.  Only a valid transaction that correctly
satisfies the conditions of the output script results in the output being
considered as "spent."</p>
</div>
<div class="paragraph">
<p><a href="#input_and_output_scripts_legacy">Combining input and output scripts to evaluate a transaction script.</a> is an example of the output and
input scripts for the most common type of legacy Bitcoin transaction (a
payment to a public key hash), showing the combined script resulting
from the concatenation of the scripts prior to
validation.</p>
</div>
<div id="input_and_output_scripts_legacy" class="imageblock">
<div class="content">
<img src="images/mbc3_0701.png" alt="input_and_output_scripts">
</div>
<div class="title">Figure 1. Combining input and output scripts to evaluate a transaction script.</div>
</div>
<div class="sect4">
<h5 id="_the_script_execution_stack">The script execution stack</h5>
<div class="paragraph">
<p>Bitcoin&#8217;s scripting language is called a stack-based language because it
uses a data structure called a <em>stack</em>. A stack is a very simple data
structure that can be visualized as a stack of cards. A stack has two
base operations: push and pop. Push adds an item on top of the stack. Pop
removes the top item from the stack.</p>
</div>
<div class="paragraph">
<p>The scripting language executes the script by processing each item from
left to right. Numbers (data constants) are pushed onto the stack.
Operators push or pop one or more parameters from the stack, act on
them, and might push a result onto the stack. For example, OP_ADD will
pop two items from the stack, add them, and push the resulting sum onto
the stack.</p>
</div>
<div class="paragraph">
<p>Conditional operators evaluate a condition, producing a boolean result
of TRUE or FALSE. For example, OP_EQUAL pops two items from the stack
and pushes TRUE (TRUE is represented by the number 1) if they are equal
or FALSE (represented by 0) if they are not equal. Bitcoin
transaction scripts usually contain a conditional operator so that they
can produce the TRUE result that signifies a valid transaction.</p>
</div>
</div>
<div class="sect4">
<h5 id="_a_simple_script">A simple script</h5>
<div class="paragraph">
<p>Now let&#8217;s apply what we&#8217;ve learned about scripts and stacks to some simple examples.</p>
</div>
<div class="paragraph">
<p>As we will see in <a href="#simplemath_script">Bitcoin&#8217;s script validation doing simple math.</a>, the script 2 3 OP_ADD 5 OP_EQUAL
demonstrates the arithmetic addition operator OP_ADD, adding two
numbers and putting the result on the stack, followed by the conditional
operator OP_EQUAL, which checks that the resulting sum is equal to
5. For brevity, the OP_ prefix may sometimes be omitted in examples
in this book. For more details on the available script operators and
functions, see <a href="https://oreil.ly/21vH9">Bitcoin Wiki&#8217;s script
page</a>.</p>
</div>
<div class="paragraph">
<p>Although most legacy output scripts refer to a public key hash (essentially, a
legacy Bitcoin address), thereby requiring proof of ownership to spend the
funds, the script does not have to be that complex. Any combination of
output and input scripts that results in a TRUE value is valid. The
simple arithmetic we used as an example of the scripting language is
also a valid script.</p>
</div>
<div class="paragraph">
<p>Use part of the arithmetic example script as the output script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>3 OP_ADD 5 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>which can be satisfied by a transaction containing an input with the
input script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2</pre>
</div>
</div>
<div class="paragraph">
<p>The validation software combines the scripts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2 3 OP_ADD 5 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>As we see in <a href="#simplemath_script">Bitcoin&#8217;s script validation doing simple math.</a>, when
this script is executed, the result is OP_TRUE, making the transaction valid.  Although this is a valid transaction
output script, note that the resulting UTXO can be spent by anyone with
the arithmetic skills
to know that the number 2 satisfies the script.</p>
</div>
<div id="simplemath_script" class="imageblock">
<div class="content">
<img src="images/mbc3_0702.png" alt="TxScriptSimpleMathExample">
</div>
<div class="title">Figure 2. Bitcoin&#8217;s script validation doing simple math.</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Transactions are valid if the
top result on the stack is TRUE, which is any
nonzero value.
Transactions are invalid if the top value on the stack is FALSE (the
value zero or an empty stack), the script
execution is halted explicitly by an operator (such as VERIFY,
OP_RETURN), or the script was not semantically valid (such as
containing an OP_IF statement that was not terminated by an OP_ENDIF
opcode).  For details, see <a href="https://oreil.ly/J2DXt">Bitcoin
Wiki&#8217;s script page</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following is a slightly more complex script, which calculates
2 + 7 â€“ 3 + 1. Notice that when the script contains several operators in
a row, the stack allows the results of one operator to be acted upon by
the next operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2 7 OP_ADD 3 OP_SUB 1 OP_ADD 7 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>Try validating the preceding script yourself using pencil and paper.
When the script execution ends, you should be left with a TRUE value
on the stack.</p>
</div>
</div>
<div class="sect4">
<h5 id="script_exec">Separate execution of output and input scripts</h5>
<div class="paragraph">
<p>In the original Bitcoin
client, output and input scripts were concatenated and executed
in sequence. For security reasons, this was changed in 2010 because of
a vulnerability known as the 1 OP_RETURN bug.  In the current
implementation, the scripts are executed separately with the stack
transferred between the two executions.</p>
</div>
<div class="paragraph">
<p>First, the input script is executed using the stack execution
engine. If the input script is executed without errors and has
no operations left over, the stack is copied and the
output script is executed. If the result of executing the output script
with the stack data copied from the input script is TRUE,
the input script has succeeded in resolving the conditions imposed
by the output script and, therefore, the input is a valid authorization
to spend the UTXO. If any result other than TRUE remains after
execution of the combined script, the input is invalid because it has
failed to satisfy the spending conditions placed on the output.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="p2pkh">Pay to Public Key Hash</h4>
<div class="paragraph">
<p>A pay to public key hash (P2PKH) script uses an output script that
contains a hash that commits to a public key.  P2PKH is best known as
the basis for a legacy Bitcoin address. A P2PKH output can be spent by
presenting a public key that matches the hash commitment and a digital
signature created by the corresponding private key (see
<a href="#c_signatures">[c_signatures]</a>).  Let&#8217;s look at an example of a P2PKH output script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_DUP OP_HASH160 &lt;Key Hash&gt; OP_EQUALVERIFY OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph less_space pagebreak-before">
<p>The Key Hash is the data that would be encoded into a legacy base58check
address.  Most applications would show the <em>public key hash</em> in a script
using hexadecimal encoding and not the familiar Bitcoin
address base58check format that begins with <span class="keep-together">a "1."</span></p>
</div>
<div class="paragraph">
<p>The preceding output script can be satisfied with an input script
of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Signature&gt; &lt;Public Key&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The two scripts together would form the following combined validation
script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Sig&gt; &lt;Pubkey&gt; OP_DUP OP_HASH160 &lt;Hash&gt; OP_EQUALVERIFY OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>The result will be TRUE if the input script
has a valid signature from Bob&#8217;s private key that corresponds to
the public key hash set as an encumbrance.</p>
</div>
<div class="paragraph">
<p>Figures <a data-type="xref" href="#P2PubKHash1"
data-xrefstyle="select: labelnumber">#P2PubKHash1</a> and <a
data-type="xref" href="#P2PubKHash2" data-xrefstyle="select:
labelnumber">#P2PubKHash2</a> show (in two parts) a step-by-step
execution of the combined script, which will prove this is a valid
transaction.</p>
</div>
<div id="P2PubKHash1" class="imageblock">
<div class="content">
<img src="images/mbc3_0703.png" alt="Tx_Script_P2PubKeyHash_1">
</div>
<div class="title">Figure 3. Evaluating a script for a P2PKH transaction (part 1 of 2).</div>
</div>
<div id="P2PubKHash2" class="imageblock">
<div class="content">
<img src="images/mbc3_0704.png" alt="Tx_Script_P2PubKeyHash_2">
</div>
<div class="title">Figure 4. Evaluating a script for a P2PKH transaction (part 2 of 2).</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multisig">Scripted Multisignatures</h3>
<div class="paragraph">
<p>Multisignature scripts set a condition where <em>k</em> public keys
are recorded in the script and at least <em>t</em> of those must provide
signatures to spend the funds, called <em>t</em>-of-<em>k</em>.
For example, a 2-of-3 multisignature is one
where three public keys are listed as potential signers and at least two
of those must be used to create signatures for a valid transaction to
spend the funds.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Some Bitcoin documentation, including earlier editions of this book,
uses the term "m-of-n" for a traditional multisignature.  However, it&#8217;s hard
to tell "m" and "n" apart when they&#8217;re spoken, so we use the alternative
<em>t</em>-of-<em>k</em>.  Both phrases refer to the same type of signature scheme.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The general form of an output script setting a <em>t</em>-of-<em>k</em> multisignature
condition is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>t &lt;Public Key 1&gt; &lt;Public Key 2&gt; ... &lt;Public Key k&gt; k OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph">
<p>where <em>k</em> is the total number of listed public keys and <em>t</em> is the threshold
of required signatures to spend the output.</p>
</div>
<div class="paragraph">
<p>An output script setting a 2-of-3 multisignature condition looks like
this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph">
<p>The preceding output script can be satisfied with an input script
containing <span class="keep-together">signatures:</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>or any combination of two signatures from the private keys corresponding
to the three listed public keys.</p>
</div>
<div class="paragraph">
<p>The two scripts together would form the combined validation script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Sig B&gt; &lt;Sig C&gt; 2 &lt;Pubkey A&gt; &lt;Pubkey B&gt; &lt;Pubkey C&gt; 3 OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph">
<p>When executed, this combined script will evaluate to TRUE if
the input script has
two valid signatures from private keys that correspond to two of
the three public keys set as an encumbrance.</p>
</div>
<div class="paragraph">
<p>At this time, Bitcoin Core&#8217;s transaction relay policy limits multisignature output scripts to, at most, three
listed public keys, meaning you can do anything from a 1-of-1 to a
3-of-3 multisignature or any combination within that range.
You may want to check the IsStandard() function to see what is currently
accepted by the network. Note that the limit of three keys applies only to
standard (also known as "bare") multisignature scripts, not to
scripts wrapped in another structure like P2SH, P2WSH, or P2TR.
P2SH multisignature scripts are limited by both policy and consensus to
15 keys, allowing for up to a 15-of-15 multisignature. We will learn about
P2SH in <a href="#p2sh">Pay to Script Hash</a>.   All other scripts are consensus limited to 20 keys
per OP_CHECKMULTISIG or OP_CHECKMULTISIGVERIFY opcode, although one
script may include multiple of those opcodes.</p>
</div>
<div class="sect3 less_space pagebreak-before">
<h4 id="multisig_bug">An Oddity in CHECKMULTISIG Execution</h4>
<div class="paragraph">
<p>There is an oddity in
OP_CHECKMULTISIG's execution that requires a slight workaround. When
OP_CHECKMULTISIG executes, it should consume <em>t</em> + <em>k</em> + 2 items on the stack as
parameters. However, due to the oddity, OP_CHECKMULTISIG will pop an extra
value or one value more than expected.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at this in greater detail using the previous validation
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Sig B&gt; &lt;Sig C&gt; 2 &lt;Pubkey A&gt; &lt;Pubkey B&gt; &lt;Pubkey C&gt; 3 OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph">
<p>First, OP_CHECKMULTISIG pops the top item, which is <em>k</em> (in this example
"3"). Then it pops <em>k</em> items, which are the public keys that can sign;
in this example, public keys A, B, and C. Then, it pops one item, which
is <em>t</em>, the quorum (how many signatures are needed). Here <em>t</em> = 2. At this
point, OP_CHECKMULTISIG should pop the final <em>t</em> items, which are the
signatures, and see if they are valid. However, unfortunately, an oddity in
the implementation causes OP_CHECKMULTISIG to pop one more item (<em>t</em> + 1
total) than it should. The extra item is called the <em>dummy stack
element</em>, and it is disregarded when checking the
signatures so it has no direct effect on OP_CHECKMULTISIG itself.
However, the dummy element must be present because, if it isn&#8217;t present
when OP_CHECKMULTISIG attempts to pop on an empty stack, it will cause a
stack error and script failure (marking the transaction as invalid).
Because the dummy element is disregarded, it can be anything. It became the custom early on to use OP_0, which later became a
relay policy rule and eventually a consensus rule (with the enforcement of BIP147).</p>
</div>
<div class="paragraph">
<p>Because popping the dummy element is part of the consensus rules, it must now be
replicated forever. Therefore a script should look
like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_0 &lt;Sig B&gt; &lt;Sig C&gt; 2 &lt;Pubkey A&gt; &lt;Pubkey B&gt; &lt;Pubkey C&gt; 3 OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph">
<p>Thus the input script actually used in multisig is not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>but instead it is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_0 &lt;Sig B&gt; &lt;Sig C&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Some people believe this oddity was a bug in the original code for
Bitcoin, but a plausible alternative explanation exists.  Verifying
<em>t</em>-of-<em>k</em> signatures can require many more than <em>t</em> or <em>k</em> signature checking
operations.  Let&#8217;s consider a simple example of 1-in-5, with the
following combined script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dummy&gt; &lt;Sig4&gt; 1 &lt;key0&gt; &lt;key1&gt; &lt;key2&gt; &lt;key3&gt; &lt;key4&gt; 5 OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph">
<p>The signature is checked first against key0, then key1, and then
the other keys before it is finally compared to its corresponding
key4.  That means five signature checking operations need to be
performed even though there&#8217;s only one signature.  One way to eliminate
this redundancy would have been to provide OP_CHECKMULTISIG a map
indicating which provided signature corresponds to which public key,
allowing the OP_CHECKMULTISIG operation to only perform exactly <em>t</em>
signature-checking operations.  It&#8217;s possible that Bitcoin&#8217;s original
developer added the extra element (which we now call the dummy stack
element) in the original version of Bitcoin so they could add the
feature for allowing a map to be passed in a later soft fork.  However,
that feature was never implemented, and the BIP147 update to the
consensus rules in 2017 makes it impossible to add that feature in the
future.</p>
</div>
<div class="paragraph">
<p>Only Bitcoin&#8217;s original developer could tell us whether the dummy stack
element was the result of a bug or a plan for a future upgrade.  In this
book, we simply call it an oddity.</p>
</div>
<div class="paragraph">
<p>From now on, if you see a multisig script, you should expect
to see an extra OP_0 in the beginning, whose only purpose is as a
workaround to an oddity in the consensus rules.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="p2sh">Pay to Script Hash</h3>
<div class="paragraph">
<p>Pay to script hash (P2SH) was
introduced in 2012 as a powerful new type of operation that greatly
simplifies the use of complex scripts. To explain the need
for P2SH, let&#8217;s look at a practical example.</p>
</div>
<div class="paragraph">
<p>Mohammed is an electronics importer based in Dubai. Mohammed&#8217;s
company uses Bitcoin&#8217;s multisignature feature extensively for its
corporate accounts. Multisignature scripts are one of the most common
uses of Bitcoin&#8217;s advanced scripting capabilities and are a very
powerful feature. Mohammed&#8217;s company
uses a multisignature script for all customer payments.
Any payments made by customers are locked in such
a way that they require at least two signatures to release.  Mohammed,
his three partners, and their attorney can each provide one signature.
A multisignature scheme like that offers corporate governance
controls and protects against theft, embezzlement, or loss.</p>
</div>
<div class="paragraph">
<p>The resulting script is quite long and looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2 &lt;Mohammed's Public Key&gt; &lt;Partner1 Public Key&gt; &lt;Partner2 Public Key&gt;
&lt;Partner3 Public Key&gt; &lt;Attorney Public Key&gt; 5 OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph">
<p>Although multisignature scripts are a powerful feature, they are
cumbersome to use. Given the preceding script, Mohammed would have to
communicate this script to every customer prior to payment. Each
customer would have to use special Bitcoin wallet software with the
ability to create custom transaction scripts.
Furthermore, the resulting transaction would be about five times larger
than a simple payment transaction, because this script contains very
long public keys. The burden of that extra data would be
borne by the customer in the form of extra transaction fees. Finally, a large transaction
script like this would be carried in the UTXO set in every full
node, until it was spent. All of these issues make using complex output scripts
difficult in practice.</p>
</div>
<div class="paragraph">
<p>P2SH was developed to resolve these practical difficulties and to make
the use of complex scripts as easy as a payment to a single-key Bitcoin address.
With P2SH payments, the complex script is replaced with a
commitment, the digest of a cryptographic hash. When a transaction attempting
to spend the UTXO is presented later, it must contain the script that
matches the commitment in addition to the data that satisfies the script. In simple terms,
P2SH means "pay to a script matching this hash, a script that will be
presented later when this output is spent."</p>
</div>
<div class="paragraph">
<p>In P2SH
transactions, the script that is replaced by a hash is referred
to as the <em>redeem script</em> because it is presented to the system at
redemption time rather than as an output script. <a href="#without_p2sh">[without_p2sh]</a> shows
the script without P2SH and <a href="#with_p2sh">[with_p2sh]</a> shows the same script encoded
with P2SH.</p>
</div>
<table id="without_p2sh">
<caption>Complex script without P2SH</caption>
<tbody>
<tr>
<td><p>Output script</p></td>
<td><p>2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 OP_CHECKMULTISIG</p></td>
</tr>
<tr>
<td><p>Input script</p></td>
<td><p>Sig1 Sig2</p></td>
</tr>
</tbody>
</table>
<table id="with_p2sh">
<caption>Complex script as P2SH</caption>
<tbody>
<tr>
<td><p>Redeem script</p></td>
<td><p>2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 OP_CHECKMULTISIG</p></td>
</tr>
<tr>
<td><p>Output script</p></td>
<td><p>OP_HASH160 &lt;20-byte hash of redeem script&gt; OP_EQUAL</p></td>
</tr>
<tr>
<td><p>Input script</p></td>
<td><p>Sig1 Sig2 &lt;redeem script&gt;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As you can see from the tables, with P2SH, the complex script that
details the conditions for spending the output (redeem script) is not
presented in the output script. Instead, only a hash of it is in the
output script, and the redeem script itself is presented later as part
of the input script when the output is spent. This shifts the burden
in fees and complexity from the spender to the receiver of the
transaction.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at Mohammed&#8217;s company, the complex multisignature script, and
the resulting P2SH scripts.</p>
</div>
<div class="paragraph">
<p>First, the multisignature script that Mohammed&#8217;s company uses for all
incoming payments from customers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2 &lt;Mohammed's Public Key&gt; &lt;Partner1 Public Key&gt; &lt;Partner2 Public Key&gt;
&lt;Partner3 Public Key&gt; &lt;Attorney Public Key&gt; 5 OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph">
<p>This entire script can instead be represented by a 20-byte cryptographic
hash by first applying the SHA256 hashing algorithm and then applying
the RIPEMD-160 algorithm on the result.  For example, starting with the
hash of Mohammed&#8217;s redeem script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>54c557e07dde5bb6cb791c7a540e0a4796f5e97e</pre>
</div>
</div>
<div class="paragraph">
<p>A P2SH transaction locks the output to this hash instead of the longer
redeem script, using a special output script template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_HASH160 54c557e07dde5bb6cb791c7a540e0a4796f5e97e OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>which, as you can see, is much shorter. Instead of "pay to this 5-key
multisignature script," the P2SH equivalent transaction is "pay to a
script with this hash." A customer making a payment to Mohammed&#8217;s
company need only include this much shorter output script in his
payment. When Mohammed and his partners want to spend this UTXO, they
must present the original redeem script (the one whose hash locked the
UTXO) and the signatures necessary to unlock it, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Sig1&gt; &lt;Sig2&gt; &lt;2 PK1 PK2 PK3 PK4 PK5 5 OP_CHECKMULTISIG&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The two scripts are combined in two stages. First, the redeem script is
checked against the output script to make sure the hash matches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;2 PK1 PK2 PK3 PK4 PK5 5 OP_CHECKMULTISIG&gt; OP_HASH160 &lt;script hash&gt; OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>If the redeem script hash matches, the redeem script is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Sig1&gt; &lt;Sig2&gt; 2 &lt;PK1&gt; &lt;PK2&gt; &lt;PK3&gt; &lt;PK4&gt; &lt;PK5&gt; 5 OP_CHECKMULTISIG</pre>
</div>
</div>
<div class="sect3">
<h4 id="_p2sh_addresses">P2SH Addresses</h4>
<div class="paragraph">
<p>Another
important part of the P2SH feature is the ability to encode a script
hash as an address, as defined in BIP13. P2SH addresses are base58check
encodings of the 20-byte hash of a script, just like Bitcoin addresses
are base58check encodings of the 20-byte hash of a public key. P2SH
addresses use the version prefix "5," which results in
base58check-encoded addresses that start with a "3."</p>
</div>
<div class="paragraph">
<p>For example, Mohammed&#8217;s complex script, hashed and base58check-encoded
as a P2SH address, becomes 39RF6JqABiHdYHkfChV6USGMe6Nsr66Gzw.</p>
</div>
<div class="paragraph">
<p>Now, Mohammed can give this "address" to his customers, and they can use
almost any Bitcoin wallet to make a simple payment, like any other
Bitcoin address. The 3 prefix gives them a hint that this is a special
type of address, one corresponding to a script instead of a public key,
but otherwise it works in exactly the same way as a payment to any other Bitcoin
address.</p>
</div>
<div class="paragraph">
<p>P2SH addresses hide all of the complexity so the person making a
payment does not see the script.</p>
</div>
</div>
<div class="sect3">
<h4 id="_benefits_of_p2sh">Benefits of P2SH</h4>
<div class="paragraph">
<p>The P2SH feature
offers the following benefits compared to the direct use of complex
scripts in outputs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The similarity to original legacy addresses means the sender and the sender&#8217;s
wallet don&#8217;t need complex engineering to implement P2SH.</p>
</li>
<li>
<p>P2SH shifts the burden in data storage for the long script from the
output (which additionally to being stored on the blockchain is in the
UTXO set) to the input (only stored on the blockchain).</p>
</li>
<li>
<p>P2SH shifts the burden in data storage for the long script from the
present time (payment) to a future time (when it is spent).</p>
</li>
<li>
<p>P2SH shifts the transaction fee cost of a long script from the sender
to the recipient, who has to include the long redeem script to spend
it.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_redeem_script_and_validation">Redeem Script and Validation</h4>
<div class="paragraph">
<p>You are not able to put a P2SH inside a P2SH redeem script because the
P2SH specification is not recursive. Also, while it is technically
possible to include OP_RETURN (see <a href="#op_return">Data Recording Output (OP_RETURN)</a>) in a redeem script, as
nothing in the rules prevents you from doing so, it is of no practical
use because executing OP_RETURN during validation will cause the
transaction to be marked invalid.</p>
</div>
<div class="paragraph">
<p>Note that because the redeem script is not presented to the network
until you attempt to spend a P2SH output, if you create an output with the
hash of an invalid redeem script, you will not be able to spend
it.  The spending transaction, which includes the redeem script,
will not be accepted because it is an invalid script. This creates a
risk because you can send bitcoin to a P2SH address that cannot be spent later.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>P2SH output scripts
contain the hash of a redeem script, which gives no clues as to
the content of the redeem script. The P2SH output will be
considered valid and accepted even if the redeem script is invalid. You
might accidentally receive bitcoin in such a way that it cannot later be
spent.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="op_return">Data Recording Output (OP_RETURN)</h3>
<div class="paragraph">
<p>Bitcoin&#8217;s
distributed and timestamped blockchain has potential uses
beyond payments. Many developers have tried to use the transaction
scripting language to take advantage of the security and resilience of
the system for applications such as digital notary services.
Early attempts to use Bitcoin&#8217;s
script language for these purposes involved creating transaction outputs
that recorded data on the blockchain; for example, to record a commitment
to a file in such a way that anyone could establish
proof-of-existence of that file on a specific date by reference to that
transaction.</p>
</div>
<div class="paragraph less_space pagebreak-before">
<p>The use of Bitcoin&#8217;s blockchain to store data
unrelated to Bitcoin payments is a controversial subject. Many
people consider such use abusive and want to discourage it. Others
view it as a demonstration of the powerful capabilities of blockchain
technology and want to encourage such experimentation. Those who object
to the inclusion of nonpayment data argue that it
burdens those running full Bitcoin nodes with carrying the
cost of disk storage for data that the blockchain was not intended to
carry. Moreover, such transactions may create UTXOs that cannot be spent,
using a legacy Bitcoin address as a freeform 20-byte field.
Because the address is used for data, it doesn&#8217;t correspond to a private
key and the resulting UTXO can <em>never</em> be spent; it&#8217;s a fake payment.
These transactions that can never be spent are therefore never removed
from the UTXO set and cause the size of the UTXO database to forever
increase, or "bloat."</p>
</div>
<div class="paragraph">
<p>A compromise was reached
that allows an output script starting with OP_RETURN to
add nonpayment data to a transaction output. However, unlike
the use of "fake" UTXOs, the OP_RETURN operator creates an explicitly
<em>provably unspendable</em> output, which does not need to be stored in the
UTXO set. OP_RETURN outputs are recorded on the blockchain, so they
consume disk space and contribute to the increase in the blockchain&#8217;s
size, but they are not stored in the UTXO set and therefore do not bloat
full nodes with the cost of more
expensive database operations.</p>
</div>
<div class="paragraph">
<p>OP_RETURN scripts look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_RETURN &lt;data&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The data portion
often represents a hash, such as the output
from the SHA256 algorithm (32 bytes). Some applications put a prefix in
front of the data to help identify the application. For example, the
<a href="https://proofofexistence.com">Proof of Existence</a> digital notarization
service uses the 8-byte prefix DOCPROOF, which is ASCII encoded as 44
4f 43 50 52 4f 4f 46 in hexadecimal.</p>
</div>
<div class="paragraph">
<p>Keep in mind that there is no input script that corresponds to
OP_RETURN that could possibly be used to "spend" an OP_RETURN output. The
whole point of an OP_RETURN output is that you can&#8217;t spend the money locked in that
output, and therefore it does not need to be held in the UTXO set as
potentially spendable: OP_RETURN outputs are <em>provably unspendable</em>. OP_RETURN outputs
usually have a zero amount because any bitcoins
assigned to such an output are effectively lost forever. If an OP_RETURN output is
referenced as an input in a transaction, the script validation engine
will halt the execution of the validation script and mark the
transaction as invalid. The execution of OP_RETURN essentially causes the
script to "RETURN" with a FALSE and halt. Thus, if you accidentally
reference an OP_RETURN output as an input in a transaction, that
transaction is invalid.</p>
</div>
<div class="sect3">
<h4 id="lock_time_limitations">Transaction Lock Time Limitations</h4>
<div class="paragraph">
<p>Use of the lock time allows a spender to restrict a transaction from
being included in a block until a specific block height, but it does not
prevent spending the funds in another transaction earlier than that.
Let&#8217;s explain that with the following example.</p>
</div>
<div class="paragraph">
<p>Alice signs a transaction spending one of her outputs to Bob&#8217;s address and sets the transaction lock time to 3 months in the future. Alice sends that transaction to Bob to hold. With this transaction Alice and Bob know that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bob cannot transmit the transaction to redeem the funds until 3 months have elapsed.</p>
</li>
<li>
<p>Bob may transmit the transaction after 3 months.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Alice can create a conflicting transaction, spending the same inputs without a lock time. Thus, Alice can spend the same UTXO before the 3 months have elapsed.</p>
</li>
<li>
<p>Bob has no guarantee that Alice won&#8217;t do that.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is important to understand the limitations of transaction lock time. The only guarantee is that Bob will not be able to redeem the presigned transaction before 3 months have elapsed. There is no guarantee that Bob will get the funds. One way to guarantee that Bob will receive the funds but cannot spend them until 3 months have elapsed is to place the timelock restriction on the UTXO itself as part of the script, rather than on the transaction. This is achieved by the next form of timelock, called Check Lock Time Verify.</p>
</div>
</div>
<div class="sect3">
<h4 id="_check_lock_time_verify_op_cltv">Check Lock Time Verify (OP_CLTV)</h4>
<div class="paragraph">
<p>In December 2015, a new form of
timelock was introduced to Bitcoin as a soft fork upgrade. Based on a
specification in BIP65, a new script operator called
OP_CHECKLOCKTIMEVERIFY (OP_CLTV) was added to the scripting language.
OP_CLTV is a per-output timelock rather than a per-transaction timelock,
as is the case with lock time. This allows for additional
flexibility in the way timelocks are applied.</p>
</div>
<div class="paragraph">
<p>In simple terms, by committing to the OP_CLTV opcode in an
output, that output is restricted so that it can only be spent after the
specified time has elapsed.</p>
</div>
<div class="paragraph">
<p>OP_CLTV doesn&#8217;t replace lock time, but rather restricts specific UTXOs
such that they can only be spent in a future transaction with
lock time set to a greater or equal value.</p>
</div>
<div class="paragraph less_space pagebreak-before">
<p>The OP_CLTV opcode takes one parameter as input, expressed as a number in
the same format as lock time (either a block height or Unix epoch
time). As indicated by the VERIFY suffix, OP_CLTV is the type of opcode
that halts execution of the script if the outcome is FALSE. If it
results in TRUE, execution continues.</p>
</div>
<div class="paragraph">
<p>In order to use OP_CLTV, you insert it into the redeem script of the
output in the transaction that creates the output. For
example, if Alice is paying Bob, he might usually accept payment to
the following P2SH script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Bob's public key&gt; OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>To lock it to a time, say 3 months from now, his P2SH script would
instead be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Bob's pubkey&gt; OP_CHECKSIGVERIFY &lt;now + 3 months&gt; OP_CHECKLOCKTIMEVERIFY</pre>
</div>
</div>
<div class="paragraph">
<p>where &lt;now {plus} 3 months&gt; is a block height or time value estimated
3 months from the time the transaction is mined: current block height
&#43; 12,960 (blocks) or current Unix epoch time &#43; 7,760,000
(seconds).</p>
</div>
<div class="paragraph">
<p>When Bob tries to spend this UTXO, he constructs a transaction that
references the UTXO as an input. He uses his signature and public key in
the input script of that input and sets the transaction lock time
to be equal or greater to the timelock in the OP_CHECKLOCKTIMEVERIFY
Alice set. Bob then broadcasts the transaction on the Bitcoin network.</p>
</div>
<div class="paragraph">
<p>Bob&#8217;s transaction is evaluated as follows. If the OP_CHECKLOCKTIMEVERIFY
parameter Alice set is less than or equal to the spending transaction&#8217;s
lock time, script execution continues (acts as if a <em>no
operation</em> or OP_NOP opcode was executed). Otherwise, script
execution halts and the transaction is deemed invalid.</p>
</div>
<div class="paragraph">
<p>More precisely, BIP65 explains that OP_CHECKLOCKTIMEVERIFY fails and
halts execution if one of the following occurs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The stack is empty.</p>
</li>
<li>
<p>The top item on the stack is less than 0.</p>
</li>
<li>
<p>The lock-time type (height versus timestamp) of the top stack item and the lock time field are not the same.</p>
</li>
<li>
<p>The top stack item is greater than the transaction&#8217;s lock time field.</p>
</li>
<li>
<p>The sequence field of the input is 0xffffffff.</p>
</li>
</ul>
</div>
<div id="timelock_conflicts" class="sidebarblock less_space pagebreak-before">
<div class="content">
<div class="title">Timelock Conflicts</div>
<div class="paragraph">
<p>OP_CLTV and lock time use the same format to describe timelocks, either
a block height or the time elapsed in seconds since the Unix epoch.
Critically, when used together, the format of lock time must match
that of OP_CLTV in the outputs&#8212;&#8203;they must both reference either
block height or time in seconds.</p>
</div>
<div class="paragraph">
<p>This implies that a script can never be valid if it must execute
two different calls to OP_CLTV, one that uses a height and one that
uses a time.  It can be easy to make this mistake when writing advanced
scripts, so be sure to thoroughly test your scripts on a test network or
use a tool designed to prevent this issue, like a Miniscript compiler.</p>
</div>
<div class="paragraph">
<p>An additional implication is that only one variety of OP_CLTV can be
used in any of the scripts of a transaction.  If the script for one
input uses the height variety and a different script for a different
input uses the time variety, there is no way to construct a valid transaction
that spends both inputs.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>After execution, if OP_CLTV is satisfied, the parameter that
preceded it remains as the top item on the stack and may need to be
dropped, with OP_DROP, for correct execution of subsequent script
opcodes. You will often see OP_CHECKLOCKTIMEVERIFY followed by OP_DROP in
scripts for this reason.  OP_CLTV, like OP_CSV (see <a href="#op_csv">Relative Timelocks</a>)
are unlike other CHECKVERIFY opcodes in leaving items on the stack
because the soft forks that added them redefined existing opcodes that
did not drop stack items, and the behavior of those previous
no-operation (NOP) opcodes must be preserved.</p>
</div>
<div class="paragraph">
<p>By using lock time in conjunction with OP_CLTV, the scenario described in
<a href="#lock_time_limitations">Transaction Lock Time Limitations</a> changes.  Alice sends her transaction
immediately, assigning the funds to Bobâ€™s key. Alice can no longer spend
the money, but Bob cannot spend it before the 3-month lock time has
expired.</p>
</div>
<div class="paragraph">
<p>By introducing timelock functionality directly into the scripting
language, OP_CLTV allows us to develop some very interesting complex
scripts.</p>
</div>
<div class="paragraph">
<p>The standard is defined in
<a href="https://oreil.ly/YmJGD">BIP65
(OP_CHECKLOCKTIMEVERIFY)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="op_csv">Relative Timelocks</h4>
<div class="paragraph">
<p>Lock time and OP_CLTV are both
<em>absolute timelocks</em> in that they specify an absolute point in time. The
next two timelock features we will examine are <em>relative timelocks</em> in
that they specify, as a condition of spending an output, an elapsed time
from the confirmation of the output in the blockchain.</p>
</div>
<div class="paragraph less_space pagebreak-before">
<p>Relative timelocks are useful because they allow
imposing a time
constraint on one transaction that is dependent on the elapsed time from
the confirmation of a previous transaction. In other words, the clock
doesn&#8217;t start counting until the UTXO is recorded on the blockchain.
This functionality is especially useful in bidirectional state channels
and Lightning Networks (LNs), as we will see in <a href="#state_channels">[state_channels]</a>.</p>
</div>
<div class="paragraph">
<p>Relative timelocks, like absolute timelocks, are implemented with both a
transaction-level feature and a script-level opcode. The
transaction-level relative timelock is implemented as a consensus rule
on the value of sequence, a transaction field that is set in every
transaction input. Script-level relative timelocks are implemented with
the OP_CHECKSEQUENCEVERIFY (OP_CSV) opcode.</p>
</div>
<div class="paragraph">
<p>Relative timelocks are
implemented according to the specifications in
<a href="https://oreil.ly/ZuANb">BIP68,
Relative Lock-Time Using Consensus-Enforced Sequence Numbers</a> and
<a href="https://oreil.ly/dLA2r">BIP112,
OP_CHECKSEQUENCEVERIFY</a>.</p>
</div>
<div class="paragraph">
<p>BIP68 and BIP112 were activated in May 2016 as a soft fork upgrade to
the consensus rules.</p>
</div>
</div>
<div class="sect3">
<h4 id="_relative_timelocks_with_op_csv">Relative Timelocks with OP_CSV</h4>
<div class="paragraph">
<p>Just like OP_CLTV
and lock time, there is a script opcode for relative timelocks that
leverages the sequence value in scripts. That opcode is
OP_CHECKSEQUENCEVERIFY, commonly referred to as OP_CSV for short.</p>
</div>
<div class="paragraph">
<p>The OP_CSV opcode when evaluated in a UTXO&#8217;s script allows
spending only in a transaction whose input sequence value is greater
than or equal to the OP_CSV parameter. Essentially, this restricts
spending the UTXO until a certain number of blocks or seconds have
elapsed relative to the time the UTXO was mined.</p>
</div>
<div class="paragraph">
<p>As with CLTV, the value in OP_CSV must match the format in the
corresponding sequence value. If OP_CSV is specified in terms of
blocks, then so must sequence. If OP_CSV is specified in terms of
seconds, then so must sequence.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>A script executing multiple OP_CSV opcodes must only use the same
variety, either time-based or height-based.  Mixing varieties will
produce an invalid script that can never be spent, the same problem we
saw with OP_CLTV in <a href="#timelock_conflicts">Timelock Conflicts</a>.  However, OP_CSV allows
any two valid inputs to be included in the same transaction, so the problem
of interaction across inputs that occurs with OP_CLTV doesn&#8217;t affect OP_CSV.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph less_space pagebreak-before">
<p>Relative timelocks with OP_CSV are especially useful when several
(chained) transactions are created and signed but not propagated&#8212;&#8203;that
is, they&#8217;re kept off the blockchain (<em>offchain</em>). A child transaction cannot be used until the
parent transaction has been propagated, mined, and aged by the time
specified in the relative timelock. One application of this use case is shown in <a href="#state_channels">[state_channels]</a> and <a href="#lightning_network">[lightning_network]</a>.</p>
</div>
<div class="paragraph">
<p>OP_CSV is defined in detail in
<a href="https://oreil.ly/z_Obw">BIP112,
CHECKSEQUENCEVERIFY</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scripts_with_flow_control_conditional_clauses">Scripts with Flow Control (Conditional Clauses)</h3>
<div class="paragraph">
<p>One of the more
powerful features of Bitcoin Script is flow control, also known as
conditional clauses. You are probably familiar with flow control in
various programming languages that use the construct IF...THEN...ELSE.
Bitcoin conditional clauses look a bit different but are essentially
the same construct.</p>
</div>
<div class="paragraph">
<p>At a basic level, Bitcoin conditional opcodes allow us to construct a
script that has two ways of being unlocked, depending on a
TRUE/FALSE outcome of evaluating a logical condition. For example,
if x is TRUE, the executed code path is A and the ELSE code path is B.</p>
</div>
<div class="paragraph">
<p>Additionally, Bitcoin conditional expressions can be "nested"
indefinitely, meaning that a conditional clause can contain another
within it, which contains another, etc. Bitcoin Script flow control can
be used to construct very complex scripts with hundreds
of possible execution paths. There is no limit to nesting, but
consensus rules impose a limit on the maximum size of a
script in bytes.</p>
</div>
<div class="paragraph">
<p>Bitcoin implements flow control using the OP_IF, OP_ELSE, OP_ENDIF, and
OP_NOTIF opcodes. Additionally, conditional expressions can contain
boolean operators such as OP_BOOLAND, OP_BOOLOR, and OP_NOT.</p>
</div>
<div class="paragraph">
<p>At first glance, you may find the Bitcoin&#8217;s flow control scripts
confusing. That is because Bitcoin Script is a stack language. The same
way that 1 {plus} 1 looks "backward" when expressed as 1 1 OP_ADD, flow
control clauses in Bitcoin also look "backward."</p>
</div>
<div class="paragraph">
<p>In most traditional (procedural) programming languages, flow control
looks like this:</p>
</div>
<div class="listingblock">
<div class="title">Pseudocode of flow control in most programming languages</div>
<div class="content">
<pre>if (condition):
  code to run when condition is true
else:
  code to run when condition is false
endif
code to run in either case</pre>
</div>
</div>
<div class="paragraph">
<p>In a stack-based language like Bitcoin Script, the logical condition
comes before the IF, which makes it look "backward":</p>
</div>
<div class="listingblock less_space pagebreak-before">
<div class="title">Bitcoin Script flow control</div>
<div class="content">
<pre>condition
IF
  code to run when condition is true
OP_ELSE
  code to run when condition is false
OP_ENDIF
code to run in either case</pre>
</div>
</div>
<div class="paragraph">
<p>When reading Bitcoin Script, remember that the condition being evaluated
comes <em>before</em> the IF opcode.</p>
</div>
<div class="sect3">
<h4 id="_conditional_clauses_with_verify_opcodes">Conditional Clauses with VERIFY Opcodes</h4>
<div class="paragraph">
<p>Another
form of conditional in Bitcoin Script is any opcode that ends in
VERIFY. The VERIFY suffix means that if the condition evaluated is
not TRUE, execution of the script terminates immediately and the
transaction is deemed invalid.</p>
</div>
<div class="paragraph">
<p>Unlike an IF clause, which offers alternative
execution paths, the VERIFY suffix acts as a <em>guard clause</em>,
continuing only if a precondition is met.</p>
</div>
<div class="paragraph">
<p>For example, the following script requires Bob&#8217;s signature and a
preimage (secret) that produces a specific hash. Both conditions must
be satisfied to unlock:</p>
</div>
<div class="listingblock">
<div class="title">A script with an OP_EQUALVERIFY  guard clause.</div>
<div class="content">
<pre>OP_HASH160 &lt;expected hash&gt; OP_EQUALVERIFY &lt;Bob's Pubkey&gt; OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>To spend this, Bob must present a
valid preimage and a signature:</p>
</div>
<div class="listingblock">
<div class="title">Satisfying the above script</div>
<div class="content">
<pre>&lt;Bob's Sig&gt; &lt;hash pre-image&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Without presenting the preimage, Bob can&#8217;t get to the part of the
script that checks for his signature.</p>
</div>
<div class="paragraph">
<p>This script can be written with an OP_IF instead:</p>
</div>
<div class="listingblock">
<div class="title">A script with an IF guard clause</div>
<div class="content">
<pre>OP_HASH160 &lt;expected hash&gt; OP_EQUAL
OP_IF
   &lt;Bob's Pubkey&gt; OP_CHECKSIG
OP_ENDIF</pre>
</div>
</div>
<div class="paragraph">
<p>Bob&#8217;s authentication data is identical:</p>
</div>
<div class="listingblock">
<div class="title">Satisfying the above script</div>
<div class="content">
<pre>&lt;Bob's Sig&gt; &lt;hash pre-image&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The script with OP_IF does the same thing as using an opcode with a
VERIFY suffix; they both operate as guard clauses. However, the
VERIFY construction is more efficient, using two fewer opcodes.</p>
</div>
<div class="paragraph">
<p>So, when do we use VERIFY and when do we use OP_IF? If all we are
trying to do is to attach a precondition (guard clause), then VERIFY
is better. If, however, we want to have more than one execution path
(flow control), then we need an OP_IF...OP_ELSE flow control clause.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_flow_control_in_scripts">Using Flow Control in Scripts</h4>
<div class="paragraph">
<p>A very common use for flow control in Bitcoin Script is to construct a
script that offers multiple execution paths, each a different way
of redeeming the UTXO.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at a simple example where
we have two signers, Alice and Bob, and either one is able to redeem.
With multisig, this would be expressed as a 1-of-2 multisig script. For
the sake of demonstration, we will do the same thing with an OP_IF
clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_IF
 &lt;Alice's Pubkey&gt;
OP_ELSE
 &lt;Bob's Pubkey&gt;
OP_ENDIF
OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>Looking at this redeem script, you may be wondering: "Where is the
condition? There is nothing preceding the IF clause!"</p>
</div>
<div class="paragraph">
<p>The condition is not part of the script. Instead, the condition
will be offered at spending time, allowing Alice and Bob to
"choose" which execution path they want:</p>
</div>
<div class="listingblock">
<div class="title">Alice satisfies the above script:</div>
<div class="content">
<pre>&lt;Alice's Sig&gt; OP_TRUE</pre>
</div>
</div>
<div class="paragraph">
<p>The OP_TRUE at the end serves as the condition (TRUE) that will make
the OP_IF clause execute the fist redemption path.  This conditions
puts the public key on the stack for which Alice has a signature.
The OP_TRUE opcode, also known as OP_1, will put the
number 1 on the stack.</p>
</div>
<div class="paragraph">
<p>For Bob to redeem this, he would have to choose the second execution
path in OP_IF by giving a FALSE value.  The OP_FALSE opcode, also
known as OP_0, pushes an empty byte array to the stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Bob's Sig&gt; OP_FALSE</pre>
</div>
</div>
<div class="paragraph">
<p>Bob&#8217;s input script causes the OP_IF clause
to execute the second (OP_ELSE) script, which requires Bob&#8217;s signature.</p>
</div>
<div class="paragraph">
<p>Since OP_IF clauses can be nested, we can create a "maze" of execution
paths. The input script can provide a "map" selecting which
execution path is actually executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_IF
  subscript A
OP_ELSE
  OP_IF
    subscript B
  OP_ELSE
    subscript C
  OP_ENDIF
OP_ENDIF</pre>
</div>
</div>
<div class="paragraph">
<p>In this scenario, there are three execution paths (subscript A, subscript
B, and subscript C). The input script provides a path in the form of
a sequence of TRUE or FALSE values. To select path subscript B, for
example, the input script must end in OP_1 OP_0 (TRUE, FALSE). These
values will be pushed onto the stack so that the second value (FALSE)
ends up at the top of the stack. The outer OP_IF clause pops the FALSE
value and executes the first OP_ELSE clause. Then the TRUE value moves
to the top of the stack and is evaluated by the inner (nested) OP_IF,
selecting the B execution path.</p>
</div>
<div class="paragraph">
<p>Using this construct, we can build redeem scripts with tens or hundreds
of execution paths, each offering a different way to redeem the UTXO. To
spend, we construct an input script that navigates the execution
path by putting the appropriate TRUE and FALSE values on the stack
at each flow control point.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_complex_script_example">Complex Script Example</h3>
<div class="paragraph">
<p>In this section we combine many of
the concepts from this chapter into a single example.</p>
</div>
<div class="paragraph">
<p>Mohammed, a company owner in Dubai, operates an import/export
business; he
wishes to construct a company capital account with flexible rules. The
scheme he creates requires different levels of authorization depending
on timelocks. The participants in the multisig scheme are Mohammed, his
two partners Saeed and Zaira, and their company lawyer. The three
partners make decisions based on a majority rule, so two of the three
must agree. However, in the case of a problem with their keys, they want
their lawyer to be able to recover the funds with one of the three
partner signatures. Finally, if all partners are unavailable or
incapacitated for a while, they want the lawyer to be able to manage the
account directly after he gains access to the capital account&#8217;s
transaction records.</p>
</div>
<div class="paragraph">
<p><a href="#variable_timelock_multisig">Variable multi-signature with timelock</a> is the redeem script that Mohammed designs to achieve this (line
numbers have been prefixed).</p>
</div>
<div id="variable_timelock_multisig" class="exampleblock">
<div class="title">Example 1. Variable multi-signature with timelock</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>01  OP_IF
02    OP_IF
03      2
04    OP_ELSE
05      &lt;30 days&gt; OP_CHECKSEQUENCEVERIFY OP_DROP
06      &lt;Lawyer's Pubkey&gt; OP_CHECKSIGVERIFY
07      1
08    OP_ENDIF
09    &lt;Mohammed's Pubkey&gt; &lt;Saeed's Pubkey&gt; &lt;Zaira's Pubkey&gt; 3 OP_CHECKMULTISIG
10  OP_ELSE
11    &lt;90 days&gt; OP_CHECKSEQUENCEVERIFY OP_DROP
12    &lt;Lawyer's Pubkey&gt; OP_CHECKSIG
13  OP_ENDIF</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Mohammed&#8217;s script implements three execution paths using nested
OP_IF...OP_ELSE flow control clauses.</p>
</div>
<div class="paragraph">
<p>In the first execution path, this script operates as a simple 2-of-3
multisig with the three partners. This execution path consists of lines
3 and 9. Line 3 sets the quorum of the multisig to 2 (2-of-3). This
execution path can be selected by putting OP_TRUE OP_TRUE at the end of the
input script:</p>
</div>
<div class="listingblock">
<div class="title">Spending data for the first execution path (2-of-3 multisig)</div>
<div class="content">
<pre>OP_0 &lt;Mohammed's Sig&gt; &lt;Zaira's Sig&gt; OP_TRUE OP_TRUE</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The OP_0 at the beginning of this input script is because of an oddity in
OP_CHECKMULTISIG that pops an extra value from the stack. The extra value
is disregarded by the OP_CHECKMULTISIG, but it must be present or the
script fails. Pushing an empty byte array with OP_0 is a workaround to the oddity, as
described in <a href="#multisig_bug">An Oddity in CHECKMULTISIG Execution</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second execution path can only be used after 30 days have elapsed
from the creation of the UTXO. At that time, it requires the signature
of the lawyer and one of the three partners (a 1-of-3 multisig).
This is achieved by line 7, which sets the quorum for the multisig to
1. To select this execution path, the input script would end in
OP_FALSE OP_TRUE:</p>
</div>
<div class="listingblock">
<div class="title">Spending data for the second execution path (Lawyer + 1-of-3)</div>
<div class="content">
<pre>OP_0 &lt;Saeed's Sig&gt; &lt;Lawer's Sig&gt; OP_FALSE OP_TRUE</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Why OP_FALSE OP_TRUE? Isn&#8217;t that backward? FALSE is pushed onto the
stack, and TRUE is pushed on top of it.
TRUE is therefore popped <em>first</em> by the first OP_IF opcode.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, the third execution path allows the lawyer to spend the
funds alone, but only after 90 days. To select this execution path, the
input script has to end in OP_FALSE:</p>
</div>
<div class="listingblock">
<div class="title">Input script for the third execution path (Lawyer only)</div>
<div class="content">
<pre>&lt;Lawyer's Sig&gt; OP_FALSE</pre>
</div>
</div>
<div class="paragraph">
<p>Try running the script on paper to see how it behaves on the stack.</p>
</div>
<div class="sect3">
<h4 id="_segregated_witness_output_and_transaction_examples">Segregated Witness Output and Transaction Examples</h4>
<div class="paragraph">
<p>Letâ€™s look at some of our example transactions and see how they would
change with segregated witness. Weâ€™ll first look at how a
 P2PKH payment can be accomplished as the
segregated witness program. Then, weâ€™ll look at the segregated witness
equivalent for P2SH scripts. Finally, weâ€™ll look at
how both of the preceding segregated witness programs can be embedded
inside a P2SH script.</p>
</div>
<div class="sect4">
<h5 id="p2wpkh">Pay to witness public key hash (P2WPKH)</h5>
<div class="paragraph">
<p>Let&#8217;s start by looking at the example of a P2PKH
output script:</p>
</div>
<div class="listingblock">
<div class="title">Example P2PKH output script</div>
<div class="content">
<pre>OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7
OP_EQUALVERIFY OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>With segregated witness, Alice would create a
P2WPKH script.  If that script commits
to the same public key, it would look like this:</p>
</div>
<div class="listingblock">
<div class="title">Example P2WPKH output script</div>
<div class="content">
<pre>0 ab68025513c3dbd2f7b92a94e0581f5d50f654e7</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, a P2WPKH output script is much
simpler than the P2PKH equivalent. It consists of two values that are
pushed onto the script evaluation stack. To an old (nonsegwit-aware)
Bitcoin client, the two pushes would look like an output that anyone can
spend. To a newer, segwit-aware client, the first number (0)
is interpreted as a version number (the <em>witness version</em>) and the
second part (20 bytes) is a
<em>witness program</em>. The 20-byte witness program is simply the hash of the
public key, as in a P2PKH script.</p>
</div>
<div class="paragraph">
<p>Now, letâ€™s look at the corresponding transaction that Bob uses to spend
this output. For the original script, the spending transaction
would have to include a signature within the transaction input:</p>
</div>
<div class="listingblock">
<div class="title">Decoded transaction showing a P2PKH output being spent with a signature</div>
<div class="content">
<pre>[...]
"vin" : [
  "txid": "abcdef12345...",
  "vout": 0,
  "scriptSig": â€œ&lt;Bobâ€™s scriptSig&gt;â€,
]
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>However, to spend the P2WPKH output, the transaction has no
signature on that input. Instead, Bobâ€™s transaction has an empty
input script and includes a witness structure:</p>
</div>
<div class="listingblock">
<div class="title">Decoded transaction showing a P2WPKH output being spent with a witness structure</div>
<div class="content">
<pre>[...]
"vin" : [
  "txid": "abcdef12345...",
  "vout": 0,
  "scriptSig": â€œâ€,
]
[...]
â€œwitnessâ€: â€œ&lt;Bobâ€™s witness structure&gt;â€
[...]</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_wallet_construction_of_p2wpkh">Wallet construction of P2WPKH</h5>
<div class="paragraph">
<p>It is extremely important to note that P2WPKH witness programs should only be created by
the receiver and not converted by the spender from a known
public key, P2PKH script, or address. The spender has no way of knowing
if the receiver&#8217;s wallet has the ability to construct segwit
transactions and spend P2WPKH outputs.</p>
</div>
<div class="paragraph">
<p>Additionally, P2WPKH outputs must be constructed from the hash of a
<em>compressed</em> public key. Uncompressed public keys are nonstandard in
segwit and may be explicitly disabled by a future soft fork. If the hash
used in the P2WPKH came from an uncompressed public key, it may be
unspendable and you may lose funds. P2WPKH outputs should be created by
the payee&#8217;s wallet by deriving a compressed public key from their
private key.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>P2WPKH should be constructed by the receiver by converting a compressed
public key to a P2WPKH hash. Neither the spender nor anyone else should
ever transform a P2PKH script, Bitcoin address, or uncompressed public
key to a P2WPKH witness script.  In general, a spender should only send
to the receiver in the manner that the receiver indicated.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="p2wsh">Pay to witness script hash (P2WSH)</h5>
<div class="paragraph">
<p>The second type of
segwit v0 witness program corresponds to a P2SH script. We
saw this type of script in <a href="#p2sh">Pay to Script Hash</a>. In that example, P2SH was used by
Mohammed&#8217;s company to express a multisignature script. Payments to
Mohammed&#8217;s company were encoded with a script like this:</p>
</div>
<div class="listingblock">
<div class="title">Example P2SH output script</div>
<div class="content">
<pre>OP_HASH160 54c557e07dde5bb6cb791c7a540e0a4796f5e97e OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>This P2SH script references the hash of a <em>redeem script</em> that defines a
2-of-3 multisignature requirement to spend funds. To spend this output,
Mohammed&#8217;s company would present the redeem script (whose hash matches
the script hash in the P2SH output) and the signatures necessary to
satisfy that redeem script, all inside the transaction input:</p>
</div>
<div class="listingblock">
<div class="title">Decoded transaction showing a P2SH output being spent</div>
<div class="content">
<pre>[...]
"vin" : [
  "txid": "abcdef12345...",
  "vout": 0,
  "scriptSig": â€œ&lt;SigA&gt; &lt;SigB&gt; &lt;2 PubA PubB PubC PubD PubE 5 OP_CHECKMULTISIG&gt;â€,
]</pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s look at how this entire example would be upgraded to segwit v0.
If Mohammed&#8217;s customers were using a segwit-compatible wallet, they
would make a payment, creating a P2WSH output that would look like this:</p>
</div>
<div class="listingblock">
<div class="title">Example P2WSH output script</div>
<div class="content">
<pre>0 a9b7b38d972cabc7961dbfbcb841ad4508d133c47ba87457b4a0e8aae86dbb89</pre>
</div>
</div>
<div class="paragraph">
<p>Again, as with the example of P2WPKH, you can see that the segregated
witness equivalent script is a lot simpler and reduces the template
overhead that you see in P2SH scripts. Instead, the segregated witness
output script consists of two values pushed to the stack: a witness version
(0) and the 32-byte SHA256 hash of the witness script (the witness
program).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>While P2SH uses the 20-byte RIPEMD160(SHA256(script)) hash, the P2WSH
witness program uses a 32-byte SHA256(script) hash. This difference in
the selection of the hashing algorithm is deliberate
to provide stronger security to
P2WSH in certain use cases (128 bits of security in P2WSH versus 80 bits
of security in P2SH).  For details, see <a href="#p2sh_collision_attacks">[p2sh_collision_attacks]</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mohammed&#8217;s company can spend the P2WSH output by presenting the
correct witness script and sufficient signatures to satisfy it. The
witness script and the signatures would be
included as part of the witness structure. No data would be placed in the
input script because this is a native witness program, which does not use
the legacy input script field:</p>
</div>
<div class="listingblock">
<div class="title">Decoded transaction showing a P2WSH output being spent with witness structure</div>
<div class="content">
<pre>[...]
"vin" : [
  "txid": "abcdef12345...",
  "vout": 0,
  "scriptSig": â€œâ€,
]
[...]
â€œwitnessâ€: â€œ&lt;SigA&gt; &lt;SigB&gt; &lt;2 PubA PubB PubC PubD PubE 5 OP_CHECKMULTISIG&gt;â€
[...]</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_differentiating_between_p2wpkh_and_p2wsh">Differentiating between P2WPKH and P2WSH</h5>
<div class="paragraph">
<p>In the previous two sections, we demonstrated two types of witness
programs: <a href="#p2wpkh">Pay to witness public key hash (P2WPKH)</a> and <a href="#p2wsh">Pay to witness script hash (P2WSH)</a>. Both types of witness programs
consist of the same version number followed by a data push. They
look very similar, but are interpreted very differently: one is
interpreted as a public key hash, which is satisfied by a signature and
the other as a script hash, which is satisfied by a witness script. The
critical difference between them is the length of the witness program:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The witness program in P2WPKH is 20 bytes.</p>
</li>
<li>
<p>The witness program in P2WSH is 32 bytes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the one difference that allows a full node to differentiate between
the two types of witness programs. By looking at the length of the hash,
a node can determine what type of witness program it is, P2WPKH or
P2WSH.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_upgrading_to_segregated_witness">Upgrading to Segregated Witness</h4>
<div class="paragraph">
<p>As we can see from the previous examples, upgrading to segregated
witness is a two-step process. First, wallets must create segwit
type outputs. Then, these outputs can be spent by wallets that know how
to construct segregated witness transactions. In the examples, Alice&#8217;s
wallet is able to create outputs paying
segregated witness output scripts. Bob&#8217;s wallet is also segwit-aware and able
to spend those outputs.</p>
</div>
<div class="paragraph">
<p>Segregated witness was implemented as a
backward-compatible upgrade, where <em>old and new clients can coexist</em>.
Wallet developers independently upgraded wallet software to add
segwit capabilities.
Legacy P2PKH and
P2SH continue to work for <span class="keep-together">nonupgraded</span> wallets. That leaves two
important scenarios, which are addressed in the next section:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ability of a spender&#8217;s wallet that is not segwit-aware to make a
payment to a recipient&#8217;s wallet that can process segwit transactions.</p>
</li>
<li>
<p>Ability of a spender&#8217;s wallet that is segwit-aware to recognize and
distinguish between recipients that are segwit-aware and ones that are
not, by their <em>addresses</em>.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_embedding_segregated_witness_inside_p2sh">Embedding segregated witness inside P2SH</h5>
<div class="paragraph">
<p>Let&#8217;s assume, for example, that Alice&#8217;s wallet is not upgraded to
segwit, but Bob&#8217;s wallet is upgraded and can handle segwit transactions.
Alice and Bob can use legacy non-segwit outputs. But Bob would
likely want to use segwit to reduce transaction fees, taking advantage
of the reduced cost of witness structure.</p>
</div>
<div class="paragraph">
<p>In this case, Bob&#8217;s wallet can construct a P2SH address that contains a
segwit script inside it. Alice&#8217;s wallet can make payments to it without
any knowledge of segwit.
Bob&#8217;s wallet can then spend this payment with a segwit transaction,
taking advantage of segwit and reducing transaction fees.</p>
</div>
<div class="paragraph">
<p>Both forms of witness scripts, P2WPKH and P2WSH, can be embedded in a
P2SH address. The first is noted as nested P2WPKH, and the second is noted
as nested P2WSH.</p>
</div>
</div>
<div class="sect4">
<h5 id="_nested_pay_to_witness_public_key_hash">Nested pay to witness public key hash</h5>
<div class="paragraph">
<p>The first form of output script we will examine is nested P2WPKH. This
is a pay to witness public key hash witness program, embedded inside a
pay to script hash script, so that a wallet that is
not aware of segwit can pay the output script.</p>
</div>
<div class="paragraph">
<p>Bob&#8217;s wallet constructs a P2WPKH witness program with Bob&#8217;s public key.
This witness program is then hashed and the resulting hash is encoded as
a P2SH script. The P2SH script is converted to a Bitcoin address, one
that starts with a "3," as we saw in <a href="#p2sh">Pay to Script Hash</a>.</p>
</div>
<div class="paragraph">
<p>Bob&#8217;s wallet starts with the P2WPKH witness version and witness program we saw earlier:</p>
</div>
<div class="listingblock">
<div class="title">Bob&#8217;s P2WPKH witness version and witness program</div>
<div class="content">
<pre>0 ab68025513c3dbd2f7b92a94e0581f5d50f654e7</pre>
</div>
</div>
<div class="paragraph">
<p>The data consists of the witness version and Bob&#8217;s
20-byte public key hash.</p>
</div>
<div class="paragraph">
<p>Bob&#8217;s wallet then hashes the data, first with
SHA256, then with RIPEMD-160, producing another 20-byte hash.
Next, the redeem script hash is converted to a Bitcoin address.
Finally, Alice&#8217;s wallet can make a payment to
37Lx99uaGn5avKBxiW26HjedQE3LrDCZru, just as it would to any other
Bitcoin address.</p>
</div>
<div class="paragraph">
<p>To pay Bob, Alice&#8217;s wallet would lock the output with a P2SH script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_HASH160 3e0547268b3b19288b3adef9719ec8659f4b2b0b OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>Even though Alice&#8217;s wallet has no support for segwit, the payment it
creates can be spent by Bob with a segwit transaction.</p>
</div>
</div>
<div class="sect4">
<h5 id="_nested_pay_to_witness_script_hash">Nested pay to witness script hash</h5>
<div class="paragraph">
<p>Similarly, a P2WSH witness program for a multisig script or other
complicated script can be embedded inside a P2SH script and address,
making it possible for any wallet to make payments that are segwit
compatible.</p>
</div>
<div class="paragraph">
<p>As we saw in <a href="#p2wsh">Pay to witness script hash (P2WSH)</a>, Mohammed&#8217;s company is using segregated witness payments to
multisignature scripts. To make it possible for any client to pay his
company, regardless of whether their wallets are upgraded for segwit,
Mohammed&#8217;s wallet can embed the P2WSH witness program inside a P2SH
script.</p>
</div>
<div class="paragraph">
<p>First, Mohammed&#8217;s wallet hashes the witness script with SHA256 (just
once), producing the hash:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73</pre>
</div>
</div>
<div class="paragraph">
<p>Next, the hashed witness script is turned into a version-prefixed P2WSH witness program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>0 9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73</pre>
</div>
</div>
<div class="paragraph">
<p>Then, the witness program itself is hashed with SHA256 and RIPEMD-160,
producing a new 20-byte hash:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>86762607e8fe87c0c37740cddee880988b9455b2</pre>
</div>
</div>
<div class="paragraph">
<p>Next, the wallet constructs a P2SH Bitcoin address from this hash:</p>
</div>
<div class="listingblock">
<div class="title">P2SH Bitcoin address</div>
<div class="content">
<pre>3Dwz1MXhM6EfFoJChHCxh1jWHb8GQqRenG</pre>
</div>
</div>
<div class="paragraph">
<p>Now, Mohammed&#8217;s clients can make payments to this address even if they
don&#8217;t support segwit. To send a payment to Mohammed, a wallet would
lock the output with the following P2SH script:</p>
</div>
<div class="listingblock">
<div class="title">P2SH script used to lock payments to Mohammed&#8217;s multisig</div>
<div class="content">
<pre>OP_HASH160 86762607e8fe87c0c37740cddee880988b9455b2 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>Mohammed&#8217;s company can then construct segwit transactions to spend these
payments, taking advantage of segwit features including lower
transaction fees.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mast">Merklized Alternative Script Trees (MAST)</h3>
<div class="paragraph">
<p>Using OP_IF, you can authorize multiple different spending conditions,
but this approach has several undesirable aspects:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Weight (cost)</dt>
<dd>
<p>Every condition you add increases the size of the
  script, increasing the weight of the transaction and the amount of fee
  that will need to be paid in order to spend bitcoins protected by
  that script.</p>
</dd>
<dt class="hdlist1">Limited size</dt>
<dd>
<p>Even if you&#8217;re willing to pay for extra conditions,
  there&#8217;s a limit to the maximum number you can put in a script.  For
  example, legacy script is limited to 10,000 bytes, practically
  limiting you to a few hundred conditional branches at most.  Even if
  you could create a script as large as an entire block, it could still
  only contain about 20,000 useful branches.  That&#8217;s a lot for simple
  payments but tiny compared to some imagined uses of Bitcoin.</p>
</dd>
<dt class="hdlist1">Lack of privacy</dt>
<dd>
<p>Every condition you add to your script becomes
  public knowledge when you spend bitcoins protected by that script.
  For example, Mohammed&#8217;s lawyer and business partners will be able to
  see the entire script in <a href="#variable_timelock_multisig">Variable multi-signature with timelock</a> whenever
  anyone spends from it.  That means their lawyer, even if he&#8217;s not
  needed for signing, will be able to track all of their transactions.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>However, Bitcoin already uses a data structure known as a merkle tree
that allows verifying an element is a member of a set without
needing to identify every other member of the set.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll learn more about merkle trees in <a href="#merkle_trees">[merkle_trees]</a>, but the
essential information is that members of the set of data we want
(e.g., authorization conditions of any length) can be passed into a hash
function to create a short commitment (called a <em>leaf</em> of the merkle
tree).  Each of those leaves is then paired with another leaf
and hashed again, creating a commitment to the leaves, called a
<em>branch</em> commitment.  A commitment to a pair of branches can be created
the same way.  This step is repeated for the branches until only one
identifier remains, called the <em>merkle root</em>.  Using our example script
from <a href="#variable_timelock_multisig">Variable multi-signature with timelock</a>, we construct a merkle tree for each
of the three authorization conditions in <a href="#diagram_mast1">A MAST with three subscripts.</a>.</p>
</div>
<div id="diagram_mast1" class="imageblock">
<div class="content">
<img src="images/mbc3_0705.png" alt="A MAST with three sub-scripts">
</div>
<div class="title">Figure 5. A MAST with three subscripts.</div>
</div>
<div class="paragraph">
<p>We can now create a compact membership proof that proves a particular
authorization condition is a member of the merkle tree without
disclosing any details about the other members of the merkle tree.  See
<a href="#diagram_mast2">A MAST membership proof for one of the subscripts.</a>, and note that the shaded nodes can be
computed from other data provided by the user, so they don&#8217;t need to be
specified at spend time.</p>
</div>
<div id="diagram_mast2" class="imageblock">
<div class="content">
<img src="images/mbc3_0706.png" alt="A MAST membership proof for one of the sub-scripts">
</div>
<div class="title">Figure 6. A MAST membership proof for one of the subscripts.</div>
</div>
<div class="paragraph less_space pagebreak-before">
<p>The hash digests used to create the commitments are each 32 bytes, so
proving that a spend of <a href="#diagram_mast2">A MAST membership proof for one of the subscripts.</a> is authorized (using a merkle tree and the
particular conditions) and authenticated (using signatures) uses 383
bytes.  By comparison, the same spend without a merkle tree (i.e., providing all possible authorization conditions) uses 412 bytes.</p>
</div>
<div class="paragraph">
<p>Saving 29 bytes (7%) in this example doesn&#8217;t fully
capture the potential savings.  The binary-tree nature of a merkle tree
means that you only need an additional 32-byte commitment every time
you double the number of members in the set (in this case, authorization
conditions).  In this instance, with three conditions, we need to use three
commitments (one of them being the merkle root, which will need to be
included in the authorization data); we could also have four
commitments for the same cost.  An extra commitment would give us up to
eight conditions.  With just 16 commitments&#8212;&#8203;512 bytes of commitments&#8212;&#8203;we could have
over 32,000 authorization conditions, far more than could be effectively
used in an entire block of transactions filled with OP_IF statements.  With 128 commitments
(4,096 bytes), the number of conditions we could create in theory far
exceeds the number of conditions that all the computers in the world
could create.</p>
</div>
<div class="paragraph">
<p>It&#8217;s commonly the case that not every authorization condition is equally
as likely to be used.  In the our example case, we expect Mohammed and
his partners to spend their money frequently; the time delayed
conditions only exist in case something goes wrong.  We can restructure
our tree with this knowledge as shown in <a href="#diagram_mast3">A MAST with the most-expected script in the best position.</a>.</p>
</div>
<div id="diagram_mast3" class="imageblock">
<div class="content">
<img src="images/mbc3_0707.png" alt="A MAST with the most-expected script in the best position">
</div>
<div class="title">Figure 7. A MAST with the most-expected script in the best position.</div>
</div>
<div class="paragraph less_space pagebreak-before">
<p>Now we only need to provide two commitments for the common case (saving 32
bytes), although we still need three commitments for the less common cases.
If you know (or can guess) the probabilities of
using the different authorization conditions, you can use the Huffman
algorithm to place them into a maximally efficient tree; see BIP341 for
details.</p>
</div>
<div class="paragraph">
<p>Regardless of how the tree is constructed, we can see in the previous
examples that we&#8217;re only revealing the actual authorization conditions
that get used.  The other conditions remain private.  Also remaining
private are the number of conditions: a tree could have a single condition
or a trillion conditions&#8212;&#8203;there&#8217;s no way for someone looking only at the
onchain data for a single transaction to tell.</p>
</div>
<div class="paragraph">
<p>Except for increasing the complexity of Bitcoin slightly, there are no
significant downsides of MAST for Bitcoin and there were two solid
proposals for it, BIP114 and BIP116, before an improved approach was
discovered, which we&#8217;ll see in <a href="#taproot">Taproot</a>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">MAST Versus MAST</div>
<div class="paragraph">
<p>The earliest idea for what we now know as <em>MAST</em> in Bitcoin was
<em>merklized abstract syntax trees</em>.  In an abstract syntax tree (AST),
every condition in a script creates a new branch, as show in <a href="#ast">An abstract syntax tree (AST) for a script.</a>.</p>
</div>
<div id="ast" class="imageblock">
<div class="content">
<img src="images/mbc3_0708.png" alt="An Abstract Syntax Tree (AST) for a script">
</div>
<div class="title">Figure 8. An abstract syntax tree (AST) for a script.</div>
</div>
<div class="paragraph">
<p>ASTs are widely used by programs that parse and optimize code for other
programs, such as compilers.  A merklized AST would commit to every part
of a program and enable the features described in
<a href="#mast">Merklized Alternative Script Trees (MAST)</a>, but it would require revealing at least one 32-byte digest for
every separate part of the program, which would not be very space
efficient on the blockchain for most programs.</p>
</div>
<div class="paragraph">
<p>What people in most cases call <em>MAST</em> in Bitcoin today is
<em>merklized alternative script trees</em>, a backronym coined by developer
Anthony Towns.  An alternative script tree is a set of scripts, each
one of them complete by itself, where only one can be selected&#8212;&#8203;making
them alternatives for each other, as shown in <a href="#alt_script">An alternative script tree.</a>.</p>
</div>
<div id="alt_script" class="imageblock">
<div class="content">
<img src="images/mbc3_0709.png" alt="An alternative script tree">
</div>
<div class="title">Figure 9. An alternative script tree.</div>
</div>
<div class="paragraph">
<p>Alternative script trees only require revealing one 32-byte digest for
each level of depth between the spender&#8217;s chosen script and the root of
the tree.  For most scripts, this is a much more efficient use of space
in the blockchain.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pay_to_contract">Pay to Contract (P2C)</h3>
<div class="paragraph">
<p>As we saw in <a href="#public_child_key_derivation">[public_child_key_derivation]</a>, the math of elliptic curve
cryptography (ECC) allows Alice to use a private key to derive a public
key that she gives to Bob.  He can add an arbitrary value to that public
key to create a derived public key.  If he gives that arbitrary value to Alice, she can
add it to her private key to derive the private key for the derived
public key.  In short, Bob can create child public keys for which only
Alice can create the corresponding private keys.  This is useful for
BIP32-style Hierarchical Deterministic (HD) wallet recovery, but it can
also serve another use.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s imagine Bob wants to buy something from Alice but he also wants to
be able prove later what he paid for in case there&#8217;s any dispute.  Alice
and Bob agree on the name of the item or service being sold (e.g.,
"Alice&#8217;s podcast episode #123"), and transform that description into a
number by hashing it and interpreting the hash digest as a number.  Bob
adds that number to Alice&#8217;s public key and pays it.  The process is
called <em>key tweaking</em>, and the number is known as a <em>tweak</em>.</p>
</div>
<div class="paragraph">
<p>Alice can spend the funds by tweaking her private key using the same
number (tweak).</p>
</div>
<div class="paragraph">
<p>Later, Bob can prove to anyone what he paid Alice by revealing her
underlying key and the description they used.  Anyone can verify that
the public key, which was paid, equals the underlying key plus the
hash commitment to the description.  If Alice admits that key is hers,
then she received the payment.  If Alice spent the funds, this further
proves she knew the description at the time she signed the spending
transaction since she could only create a valid signature for the
tweaked public key if she knew the tweak (the description).</p>
</div>
<div class="paragraph">
<p>If neither Alice nor Bob decided to publicly reveal the description they
use, the payment between them looks like any other payment.  There&#8217;s no
privacy loss.</p>
</div>
<div class="paragraph">
<p>Because P2C is private by default, we can&#8217;t know how often it is used
for its original purpose&#8212;&#8203;in theory every payment could be using it,
although we consider that unlikely.  However, P2C is widely used today
in a slightly different form, which we&#8217;ll see in <a href="#taproot">Taproot</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="scriptless_multisignatures_and_threshold_signatures">Scriptless Multisignatures and Threshold Signatures</h3>
<div class="paragraph">
<p>In <a href="#multisig">Scripted Multisignatures</a>, we looked at scripts that require signatures from
multiple keys.  However, there&#8217;s another way to require cooperation from
multiple keys, which is also confusingly called <em>multisignature</em>.  To
distinguish between the two types in this section, we&#8217;ll call the
version involving <code>OP_CHECKSIG</code>-style opcodes <em>script multisignatures</em>
and the other version <em>scriptless multisignatures</em>.</p>
</div>
<div class="paragraph">
<p>Scriptless multisignatures involve each participant creating their own
secret the same way they create a private key.  We&#8217;ll call this secret a
<em>partial private key</em>, although we should note that it&#8217;s the same length
as a regular full private key.  From the partial private key, each
participant derives a partial public key using the same algorithm used
for regular public keys we described in <a href="#public_key_derivation">[public_key_derivation]</a>.  Each
participant shares their partial public keys with all the other
participants and then combines all of the keys together to create the
scriptless multisignature public key.</p>
</div>
<div class="paragraph">
<p>This combined public key looks the same as any other Bitcoin public key.
A third party can&#8217;t distinguish between a multiparty public key and an
ordinary key generated by a single user.</p>
</div>
<div class="paragraph">
<p>To spend bitcoins protected by the scriptless multisignature public key,
each participant generates a partial signature.  The partial signatures
are then combined to create a regular full signature.  There are
many known methods for creating and combining the partial signatures;
we&#8217;ll look at this topic more in <a href="#c_signatures">[c_signatures]</a>.  Similar to the public
keys for scriptless multisignatures, the signatures generated by this
process look the same as any other Bitcoin signature.  Third parties
can&#8217;t determine whether a signature was created by a single person or a
million people cooperating with each other.</p>
</div>
<div class="paragraph">
<p>Scriptless multisignatures are smaller and more private than scripted
multisignatures.  For scripted multisignatures, the number of bytes
placed in a transaction increases for every key and signature involved.
For scriptless multisignatures, the size is constant&#8212;&#8203;a million
participants each providing their own partial key and partial signature
puts exactly the same amount of data in a transaction as an individual
using a single key and signature.  The story is the same for privacy:
because each new key or signature adds data to a transaction, scripted
multisignatures disclose data about how many keys and signatures are
being used&#8212;&#8203;which may make it easy to figure out which transactions were
created by which group of participants.  However, because every scriptless
multisignatures looks like every other scriptless
multisignature and every single-signature, no privacy-reducing data is
leaked.</p>
</div>
<p class="fix_tracking">
There are two downsides of scriptless multisignatures.  The first is
that all known secure algorithms for creating them for Bitcoin require more
rounds of interaction or more careful management of state than
scripted multisignatures.  This can be challenging in cases where
signatures are being generated by nearly stateless hardware signing
devices and the keys are physically distributed.  For example, if you
keep a hardware signing device in a bank safe deposit box, you would
need to visit that box once to create a scripted multisignature but
possibly two or three times for a scriptless multisignature.
</p>
<div class="paragraph">
<p>The other downside is that threshold signing doesn&#8217;t reveal who signed.
In scripted threshold signing, Alice, Bob, and Carol agree (for example)
that any two of them signing will be sufficient to spend the funds.
If Alice and Bob sign, this requires putting signatures from each of
them on chain, proving to anyone who knows their keys that they signed
and Carol didn&#8217;t.  In scriptless threshold signing, a signature from
Alice and Bob is indistinguishable from a signature between Alice and
Carol or Bob and Carol.  This is beneficial for privacy, but it means
that, even if Carol claims she didn&#8217;t sign, she can&#8217;t
prove that she didn&#8217;t, which may be bad for accountability and
auditability.</p>
</div>
<div class="paragraph">
<p>For many users and use cases, the always reduced size and increased
privacy of multisignatures outweighs its occasional challenges for
creating and auditing signatures.</p>
</div>
</div>
<div class="sect2">
<h3 id="taproot">Taproot</h3>
<div class="paragraph">
<p>One reason people choose to use Bitcoin is that it&#8217;s possible to create
contracts with highly predictable outcomes.  Legal contracts enforced by
a court of law depend in part on decisions by the judges and jurors
involved in the case.  By contrast, Bitcoin contracts often require
actions by their participants but are otherwise enforced by thousands of
full nodes all running functionally identical code.  When given the same
contract and the same input, every full node will always produce the
same result.  Any deviation would mean that Bitcoin was broken.
Human judges and juries can be much more flexible than software, but
when that flexibility isn&#8217;t wanted or needed, the predictability of
Bitcoin contracts is a major asset.</p>
</div>
<div class="paragraph">
<p>If all of the participants in a contract recognize that its outcome has
become completely predictable, there&#8217;s not actually any need for them to
continue using the contract.  They could just do whatever the contract
compels them to do and then terminate the contract.  In society, this
is how most contracts terminate: if the interested parties are
satisfied, they never take the contract before a judge or jury.  In
Bitcoin, it means that any contract that will use a significant amount
of block space to settle should also provide a clause that allows it to
instead be settled by mutual satisfaction.</p>
</div>
<div class="paragraph">
<p>In MAST and with scriptless multisignatures, a mutual satisfaction
clause is easy to design.  We simply make one of the top leaves of the
script tree a scriptless multisignature between all interested parties.
We already saw a complex contract between several parties with a
simple mutual satisfaction clause in <a href="#diagram_mast3">A MAST with the most-expected script in the best position.</a>.  We could make
that more optimized by switching from scripted multisignature to
scriptless multisignature.</p>
</div>
<div class="paragraph">
<p>That&#8217;s reasonably efficient and private.  If the mutual satisfaction
clause is used, we only need to provide a single merkle branch and all
we reveal is that a signature was involved (it could be from one person
or it could be from thousands of different participants).  But
developers in 2018 realized that we could do better if we also used
pay to contract.</p>
</div>
<div class="paragraph">
<p>In our previous description of pay to contract in <a href="#pay_to_contract">Pay to Contract (P2C)</a>,
we tweaked a public key to commit to the text of an agreement between
Alice and Bob.  We can instead commit to the program code of a contract
by committing to the root of a MAST.  The public key we tweak
is a regular Bitcoin public key, meaning it could require a signature
from a single person or it could require a signature from multiple
people (or it could be created in a special way to make it impossible to
generate a signature for it).  That means we can satisfy the contract
either with a single signature from all interested parties or by
revealing the MAST branch we want to use.  That commitment tree
involving both a public key and a MAST is shown in <a href="#diagram_taproot1">A taproot with the public key committing to a merkle root.</a>.</p>
</div>
<div id="diagram_taproot1" class="imageblock">
<div class="content">
<img src="images/mbc3_0710.png" alt="A taproot with the public key committing to a merkle root">
</div>
<div class="title">Figure 10. A taproot with the public key committing to a merkle root.</div>
</div>
<div class="paragraph">
<p>This makes the mutual satisfaction clause using a multisignature
extremely efficient and very private.  It&#8217;s even more private than it
may appear because any transaction created by a single user who wants it
to be satisfied by a single signature (or a multisignature generated by
multiple different wallets they control) looks identical onchain to a
mutual-satisfaction spend.  There&#8217;s no onchain difference in this case
between a spend by a million users involved in an extraordinarily complex
contract or a single user just spending their saved bitcoins.</p>
</div>
<div class="paragraph">
<p>When spending is possible using just the key, such as for a single signature
or scriptless multisignature, that is called <em>keypath spending</em>.  When
the tree of scripts is used, that is called <em>scriptpath spending</em>.
For keypath spending, the data that gets put onchain is the public key
(in a witness program) and the signature (on the witness stack).</p>
</div>
<div class="paragraph">
<p>For scriptpath spending, the onchain data also includes the public key,
which is placed in a witness program and called the <em>taproot output key</em>
in this context.  The witness structure includes the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A version number.</p>
</li>
<li>
<p>The underlying key&#8212;&#8203;the key that existed before being tweaked by the
merkle root to produce the taproot output key.  This underlying key
is called the <em>taproot internal key</em>.</p>
</li>
<li>
<p>The script to execute, called the <em>leaf script</em>.</p>
</li>
<li>
<p>One 32-byte hash for each junction in merkle tree along the path that connects the leaf to the merkle root.</p>
</li>
<li>
<p>Any data necessary to satisfy the script (such as signatures or hash preimages).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;re only aware of one significant described downside of taproot:
contracts whose participants want to use MAST but who don&#8217;t want a
mutual satisfaction clause have to include a taproot internal key on the
blockchain, adding about 33 bytes of overhead. Given that almost
all contracts are expected to benefit from a mutual satisfaction clause,
or other multisignature clause that uses the top-level public key, and
all users benefit from the increased anonymity set of outputs looking
similar to each other, that rare overhead was not considered important
by most users who participated in taproot&#8217;s activation.</p>
</div>
<div class="paragraph">
<p>Support for taproot was added to Bitcoin in a soft fork that activated
in November 2021.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tapscript">Tapscript</h3>
<div class="paragraph">
<p>Taproot enables MAST but only with a slightly different version of the
Bitcoin Script language than previously used, the new version being
called <em>tapscript</em>.  The major differences include:</p>
</div>
<div class="dlist less_space pagebreak-before">
<dl>
<dt class="hdlist1">Scripted multisignature changes</dt>
<dd>
<p>The old OP_CHECKMULTISIG and OP_CHECKMULTISIGVERIFY opcodes are
removed.  Those opcodes don&#8217;t combine well with one of the other
changes in the taproot soft fork, the ability to use schnorr signatures
with batch validation (see <a href="#schnorr_signatures">[schnorr_signatures]</a>).  A new OP_CHECKSIGADD opcode is provided
instead.  When it successfully verifies a signature, this new opcode
increments a counter by one, making it possible to conveniently count
how many signatures passed, which can be compared against the desired number
of successful signatures to reimplement the same behavior as
OP_CHECKMULTISIG.</p>
</dd>
<dt class="hdlist1">Changes to all signatures</dt>
<dd>
<p>All signature operations in tapscript use the schnorr signature
algorithm as defined in BIP340.  We&#8217;ll explore schnorr signatures more
in <a href="#c_signatures">[c_signatures]</a>.</p>
<div class="paragraph">
<p>Additionally, any signature-checking operation that is not expected
  to succeed must be fed the value OP_FALSE (also called OP_0)
  instead of an actual signature.  Providing anything else to a failed
  signature-checking operation will cause the entire script to fail.
  This also helps support batch validation of schnorr signatures.</p>
</div>
</dd>
<dt class="hdlist1">OP_SUCCESSx opcodes</dt>
<dd>
<p>Opcodes in previous versions of Script that were unusable are now
redefined to cause an entire script to succeed if they are used.
This allows future soft forks to redefine them as not succeeding under
certain circumstances, which
is a restriction and so is possible to do in a soft fork.  (The
opposite, to define a not-succeeding operation as a success can only
be done in a hard fork, which is a much more challenging upgrade
path.)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Although we&#8217;ve looked at authorization and authentication in depth in
this chapter, we&#8217;ve skipped over one very important part of how Bitcoin
authenticates spenders: its signatures.  We&#8217;ll look at that next in
<a href="#c_signatures">[c_signatures]</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-03-19 23:56:16 +0800
</div>
</div>
</body>
</html>