<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.22">
<title>Digital Signatures</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="c_signatures">Digital Signatures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Two signature algorithms are currently
used in Bitcoin, the <em>schnorr signature algorithm</em> and the <em>Elliptic
Curve Digital Signature Algorithm</em> (<em>ECDSA</em>).
These algorithms are used for digital signatures based on elliptic
curve private/public key pairs, as described in <a href="#elliptic_curve">[elliptic_curve]</a>.
They are used for spending segwit v0 P2WPKH outputs, segwit v1 P2TR
keypath spending, and by the script functions OP_CHECKSIG,
OP_CHECKSIGVERIFY, OP_CHECKMULTISIG, <span class="keep-together">OP_CHECKMULTISIGVERIFY,</span> and
OP_CHECKSIGADD.
Any time one of those is executed, a signature must be
provided.</p>
</div>
<div class="paragraph">
<p>A digital signature serves
three purposes in Bitcoin. First, the
signature proves that the controller of a private key, who is by
implication the owner of the funds, has <em>authorized</em> the spending of
those funds. Secondly, the proof of authorization is <em>undeniable</em>
(nonrepudiation). Thirdly, that the authorized transaction cannot be
changed by unauthenticated third parties&#8212;&#8203;that its <em>integrity</em> is
intact.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Each transaction input and any signatures it may contain is <em>completely</em>
independent of any other input or signature. Multiple parties can
collaborate to construct transactions and sign only one input each.
Several protocols use this fact to create multiparty transactions for
privacy.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this chapter we look at how digital signatures work and how they can
present proof of control of a private key without revealing that private
key.</p>
</div>
<div class="sect2 less_space pagebreak-before">
<h3 id="_how_digital_signatures_work">How Digital Signatures Work</h3>
<div class="paragraph">
<p>A digital signature
consists of two parts. The first part is an algorithm for creating a
signature for a message (the transaction) using a private key (the
signing key). The second part is an algorithm
that allows anyone to verify the signature, given also the message and the corresponding
public key.</p>
</div>
<div class="sect3">
<h4 id="_creating_a_digital_signature">Creating a Digital Signature</h4>
<div class="paragraph">
<p>In Bitcoin&#8217;s use of digital signature algorithms, the "message" being
signed is the transaction, or more accurately a hash of a specific
subset of the data in the transaction, called the <em>commitment hash</em> (see
<a href="#sighash_types">Signature Hash Types (SIGHASH)</a>). The
signing key is the user&#8217;s private key. The result is the signature:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
Sig = F_{sig}(F_{hash}(m), x)
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>x</em> is the signing private key</p>
</li>
<li>
<p><em>m</em> is the message to sign, the commitment hash (such as parts of a transaction)</p>
</li>
<li>
<p><em>F</em><sub><em>hash</em></sub> is the hashing function</p>
</li>
<li>
<p><em>F</em><sub><em>sig</em></sub> is the signing algorithm</p>
</li>
<li>
<p><em>Sig</em> is the resulting signature</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find more details on the mathematics of schnorr and ECDSA signatures in <a href="#schnorr_signatures">Schnorr Signatures</a>
and <a href="#ecdsa_signatures">ECDSA Signatures</a>.</p>
</div>
<div class="paragraph">
<p>In both schnorr and ECDSA signatures, the function <em>F</em><sub><em>sig</em></sub> produces a signature Sig that is composed of
two values.  There are differences between the two values in the
different algorithms, which we&#8217;ll explore later. After the two values
are calculated, they are serialized into a byte stream.  For ECDSA
signatures, the encoding uses an international standard encoding scheme
called the
<em>Distinguished Encoding Rules</em>, or <em>DER</em>.  For schnorr signatures, a
simpler serialization format is used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_verifying_the_signature">Verifying the Signature</h4>
<div class="paragraph">
<p>The signature verification algorithm takes the message (a hash of parts of the transaction and related data), the signer&#8217;s public key and the signature, and returns TRUE if the signature is valid for this message and public key.</p>
</div>
<div class="paragraph">
<p>To verify the signature, one must have the signature, the serialized
transaction, some data about the output being spent, and the public key
that corresponds to the private key used to create the signature.
Essentially, verification of a signature means "Only the controller of
the private key that generated this public key could have produced this
signature on this transaction."</p>
</div>
</div>
<div class="sect3">
<h4 id="sighash_types">Signature Hash Types (SIGHASH)</h4>
<div class="paragraph">
<p>Digital signatures apply to messages,
which in the case of Bitcoin, are the transactions themselves. The
signature proves a <em>commitment</em> by the signer to specific transaction
data. In the simplest form, the signature applies to almost the entire
transaction, thereby committing to all the inputs, outputs, and other
transaction fields. However, a signature can commit to only a subset of
the data in a transaction, which is useful for a number of scenarios as
we will see in this section.</p>
</div>
<div class="paragraph">
<p>Bitcoin signatures have a way of indicating which
part of a transaction&#8217;s data is included in the hash signed by the
private key using a SIGHASH flag. The SIGHASH flag is a single byte
that is appended to the signature. Every signature has either an
explicit or implicit SIGHASH flag,
and the flag can be different from input to input. A transaction with
three signed inputs may have three signatures with different SIGHASH
flags, each signature signing (committing) to different parts of the
transaction.</p>
</div>
<div class="paragraph">
<p>Remember, each input may contain one or more signatures. As
a result, an input may have signatures
with different SIGHASH flags that commit to different parts of the
transaction. Note also that Bitcoin transactions
may contain inputs from different "owners," who may sign only one input
in a partially constructed transaction, collaborating with
others to gather all the necessary signatures to make a valid
transaction. Many of the SIGHASH flag types only make sense if you
think of multiple participants collaborating outside the Bitcoin network
and updating a partially signed transaction.</p>
</div>
<div class="paragraph">
<p>There are three SIGHASH flags: ALL, NONE, and SINGLE, as shown
in <a href="#sighash_types_and_their">[sighash_types_and_their]</a>.</p>
</div>
<table id="sighash_types_and_their">
<caption>
<span class="plain"><code>SIGHASH</code></span> types and their meanings</caption>
<thead>
<tr>
<th><code>SIGHASH</code> flag</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>ALL</code></p></td>
<td><p><code>0x01</code></p></td>
<td><p>Signature applies to all inputs and outputs</p></td>
</tr>
<tr>
<td><p><code>NONE</code></p></td>
<td><p><code>0x02</code></p></td>
<td><p>Signature applies to all inputs, none of the outputs</p></td>
</tr>
<tr>
<td><p><code>SINGLE</code></p></td>
<td><p><code>0x03</code></p></td>
<td><p>Signature applies to all inputs but only the one output with the same index number as the signed input</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, there is a modifier flag, SIGHASH_ANYONECANPAY, which can
be combined with each of the preceding flags. When ANYONECANPAY is
set, only one input is signed, leaving the rest (and their sequence
numbers) open for modification. The ANYONECANPAY has the value 0x80
and is applied by bitwise OR, resulting in the combined flags as shown
in <a href="#sighash_types_with_modifiers">[sighash_types_with_modifiers]</a>.</p>
</div>
<table id="sighash_types_with_modifiers">
<caption>
<span class="plain"><code>SIGHASH</code></span> types with modifiers and their meanings</caption>
<thead>
<tr>
<th><code>SIGHASH</code> flag</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>ALL|ANYONECANPAY</code></p></td>
<td><p><code>0x81</code></p></td>
<td><p>Signature applies to one input and all outputs</p></td>
</tr>
<tr>
<td><p><code>NONE|ANYONECANPAY</code></p></td>
<td><p><code>0x82</code></p></td>
<td><p>Signature applies to one input, none of the outputs</p></td>
</tr>
<tr>
<td><p><code>SINGLE|ANYONECANPAY</code></p></td>
<td><p><code>0x83</code></p></td>
<td><p>Signature applies to one input and the output with the same index number</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The way SIGHASH flags are applied during signing and verification is
that a copy of the transaction is made and certain fields within are
either omitted or truncated (set to zero length and emptied). The resulting transaction is
serialized. The SIGHASH flag is included in the serialized
transaction data and the result is hashed. The hash digest itself is the "message"
that is signed. Depending on which SIGHASH flag is used, different
parts of the transaction are included.
By including the
SIGHASH flag itself, the signature commits the
SIGHASH type as well, so it can&#8217;t be changed (e.g., by a miner).</p>
</div>
<div class="paragraph">
<p>In
<a href="#serialization_of_signatures_der">Serialization of ECDSA Signatures (DER)</a>, we will see that the last part of the
DER-encoded signature was 01, which is the SIGHASH_ALL flag for ECDSA signatures. This
locks the transaction data, so Alice&#8217;s signature is committing to the state
of all inputs and outputs. This is the most common signature form.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at some of the other SIGHASH types and how they can be used
in practice:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ALL|ANYONECANPAY </dt>
<dd>
<p>This construction can be used to make a
"crowdfunding&#x201d;-style transaction. Someone attempting to raise
funds can construct a transaction with a single output. The single
output pays the "goal" amount to the fundraiser. Such a transaction is
obviously not valid, as it has no inputs. However, others can now amend
it by adding an input of their own as a donation. They sign their own
input with ALL|ANYONECANPAY. Unless enough inputs are gathered to
reach the value of the output, the transaction is invalid. Each donation
is a "pledge," which cannot be collected by the fundraiser until the
entire goal amount is raised.  Unfortunately, this protocol can be
circumvented by the fundraiser adding an input of their own (or from
someone who lends them funds), allowing them to collect the donations
even if they haven&#8217;t reached the specified value.</p>
</dd>
<dt class="hdlist1">NONE </dt>
<dd>
<p>This construction can be used to create a "bearer check" or
"blank check" of a specific amount. It commits to all inputs but allows
the outputs to be changed. Anyone can write their own
Bitcoin address into the output script.
By itself, this allows any miner to change
the output destination and claim the funds for themselves, but if other
required signatures in the transaction use SIGHASH_ALL or another type
that commits to the output, it allows those spenders to change the
destination without allowing any third parties (like miners) to modify
the outputs.</p>
</dd>
<dt class="hdlist1">NONE|ANYONECANPAY </dt>
<dd>
<p>This construction can be used to build a "dust
collector." Users who have tiny UTXOs in their wallets can&#8217;t spend these
without the cost in fees exceeding the value of the UTXO; see
<a href="#uneconomical_outputs">[uneconomical_outputs]</a>. With this type
of signature, the uneconomical UTXOs can be donated for anyone to aggregate and
spend whenever they want.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>There are some proposals to modify or
expand the SIGHASH system.  The most widely discussed proposal as of
this writing is BIP118, which proposes to add two
new sighash flags.  A signature using SIGHASH_ANYPREVOUT would not
commit to an input&#8217;s outpoint field, allowing it to be used to spend any
previous output for a particular witness program.  For example, if Alice
receives two outputs for the same amount to the same witness program
(e.g., requiring a single signature from her wallet), a
SIGHASH_ANYPREVOUT signature for spending either one of those outputs
could be copied and used to spend the other output to the same
destination.</p>
</div>
<div class="paragraph">
<p>A signature using SIGHASH_ANYPREVOUTANYSCRIPT would not
commit to the outpoint, the amount, the witness program, or the
specific leaf in the taproot merkle tree (script tree), allowing it to spend any previous output that the signature could satisfy.  For example, if Alice received two
outputs for different amounts and different witness programs (e.g., one
requiring a single signature and another requiring her signature plus some
other data), a SIGHASH_ANYPREVOUTANYSCRIPT signature for spending
either one of those outputs could be copied and used to spend the other
output to the same destination (assuming the extra data for the second
output was known).</p>
</div>
<div class="paragraph">
<p>The main expected use for the two SIGHASH_ANYPREVOUT opcodes is improved
payment channels, such as those used in the Lightning Network (LN), although
several other uses have been described.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You will not often see SIGHASH flags presented as an option in a user&#8217;s
wallet application.  Simple wallet applications
sign with <span class="keep-together">SIGHASH_ALL</span> flags.  More sophisticated applications, such as
LN nodes, may use alternative SIGHASH flags, but they
use protocols that have been extensively reviewed to understand the
influence of the alternative flags.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="schnorr_signatures">Schnorr Signatures</h3>
<div class="paragraph">
<p>In 1989, Claus Schnorr published a paper describing the signature
algorithm that&#8217;s become eponymous with him.  The algorithm isn&#8217;t
specific to the elliptic curve cryptography (ECC) that Bitcoin and many
other applications use, although it is perhaps most strongly associated
with ECC today.  Schnorr signatures have a number of nice properties:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Provable security</dt>
<dd>
<p>A mathematical proof of the security of schnorr signatures depends on
only the difficulty of solving the Discrete Logarithm Problem (DLP),
particularly for elliptic curves (EC) for Bitcoin, and the ability of
a hash function (like the SHA256 function used in Bitcoin) to produce
unpredictable values, called the random oracle model (ROM).  Other
signature algorithms have additional dependencies or require much
larger public keys or signatures for equivalent security to
ECC-Schnorr (when the threat is defined as classical computers; other
algorithms may provide more efficient security against quantum
computers).</p>
</dd>
<dt class="hdlist1">Linearity</dt>
<dd>
<p>Schnorr signatures have a property that mathematicians call
<em>linearity</em>, which applies to functions with two particular
properties.  The first property is that summing together two or more
variables and then running a function on that sum will produce the
same value as running the function on each of the variables
independently and then summing together the results, e.g.,
<em>f(x</em> + <em>y</em> + <em>z)</em> == <em>f(x)</em> + <em>f(y)</em> + <em>f(z)</em>; this property is called
<em>additivity</em>.  The second property is that multiplying a variable and
then running a function on that product will produce the same value as
running the function on the variable and then multiplying it by the
same amount, e.g., <em>f(a</em> × <em>x)</em> == <em>a</em> × <em>f(x)</em>; this property is called
<em>homogeneity of degree 1</em>.</p>
<div class="paragraph">
<p>In cryptographic operations, some functions may be private (such
  as functions involving private keys or secret nonces), so being able
  to get the same result whether performing an operation inside or
  outside of a function makes it easy for multiple parties to coordinate
  and cooperate without sharing their secrets.  We&#8217;ll see some of the
  specific benefits of linearity in schnorr signatures in
  <a href="#schnorr_multisignatures">Schnorr-based Scriptless Multisignatures</a> and <a href="#schnorr_threshold_signatures">Schnorr-based Scriptless Threshold Signatures</a>.</p>
</div>
</dd>
<dt class="hdlist1">Batch verification</dt>
<dd>
<p>When used in a certain way (which Bitcoin does), one consequence of
schnorr&#8217;s linearity is that it&#8217;s relatively straightforward to verify
more than one schnorr signature at the same time in less time than it
would take to verify each signature independently.  The more
signatures that are verified in a batch, the greater the speed up.
For the typical number of signatures in a block, it&#8217;s possible to
batch verify them in about half the amount of time it would take to
verify each signature independently.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Later in this chapter, we&#8217;ll describe the schnorr signature algorithm
exactly as it&#8217;s used in Bitcoin, but we&#8217;re going to start with a
simplified version of it and work our way toward the actual protocol in
stages.</p>
</div>
<div class="paragraph less_space pagebreak-before">
<p>Alice starts by choosing a large random number (<em>x</em>), which we call her
<em>private key</em>.  She also knows a public point on Bitcoin&#8217;s elliptic
curve called the Generator (<em>G</em>) (see <a href="#public_key_derivation">[public_key_derivation]</a>).  Alice uses EC
multiplication to multiply <em>G</em> by her private key <em>x</em>, in which case <em>x</em>
is called a <em>scalar</em> because it scales up <em>G</em>.  The result is <em>xG</em>,
which we call Alice&#8217;s <em>public key</em>.  Alice gives her public key to Bob.
Even though Bob also knows <em>G</em>, the DLP prevents Bob from being able to divide <em>xG</em> by <em>G</em> to derive Alice&#8217;s
private key.</p>
</div>
<div class="paragraph">
<p>At some later time, Bob wants Alice to identify herself by proving
that she knows the scalar <em>x</em> for the public key (<em>xG</em>) that Bob
received earlier.  Alice can&#8217;t give Bob <em>x</em> directly because that would
allow him to identify as her to other people, so she needs to prove
her knowledge of <em>x</em> without revealing <em>x</em> to Bob, called a
<em>zero-knowledge proof</em>.  For that, we begin the schnorr identity
process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Alice chooses another large random number (<em>k</em>), which we call the
<em>private nonce</em>.  Again she uses it as a scalar, multiplying it by <em>G</em>
to produce <em>kG</em>, which we call the <em>public nonce</em>.  She gives the
public nonce to Bob.</p>
</li>
<li>
<p>Bob chooses a large random number of his own, <em>e</em>, which we call the
<em>challenge scalar</em>.  We say "challenge" because it&#8217;s used to challenge
Alice to prove that she knows the private key (<em>x</em>) for the public key
(<em>xG</em>) she previously gave Bob; we say "scalar" because it will later
be used to multiply an EC point.</p>
</li>
<li>
<p>Alice now has the numbers (scalars) <em>x</em>, <em>k</em>, and <em>e</em>.  She combines
them together to produce a final scalar <em>s</em> using the formula
<em>s</em> = <em>k</em> + <em>ex</em>.  She gives <em>s</em> to Bob.</p>
</li>
<li>
<p>Bob now knows the scalars <em>s</em> and <em>e</em>, but not <em>x</em> or <em>k</em>.  However,
Bob does know <em>xG</em> and <em>kG</em>, and he can compute for himself <em>sG</em> and
<em>exG</em>.  That means he can check the equality of a scaled-up version of
the operation Alice performed: <span class="keep-together"><em>sG</em> == <em>kG</em> + <em>exG</em>.</span>  If that is equal,
then Bob can be sure that Alice knew <em>x</em> when she generated <em>s</em>.</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Schnorr Identity Protocol with Integers Instead of Points</div>
<div class="paragraph">
<p>It might be easier to understand the interactive schnorr identity
protocol if we create an insecure oversimplification by substituting each of the preceding values (including <em>G</em>) with simple integers instead of points on an elliptic curve.
For example, we&#8217;ll use the prime numbers starting with 3:</p>
</div>
<div class="paragraph">
<p>Setup: Alice chooses <em>x</em> = 3 as her private key.  She multiplies it by the
generator <em>G</em> = 5 to get her public key <em>xG</em> = 15.  She gives Bob 15.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Alice chooses the private nonce <em>k</em> = 7 and generates the public nonce
<em>kG</em> = 35.  She gives Bob 35.</p>
</li>
<li>
<p>Bob chooses <em>e</em> = 11 and gives it to Alice.</p>
</li>
<li>
<p>Alice generates <em>s</em> = 40 = 7 + 11 × 3.  She gives Bob 40.</p>
</li>
<li>
<p>Bob derives <em>sG</em> = 200 = 40 × 5 and <em>exG</em> = 165 = 11 × 15.  He then
verifies that <span class="keep-together">200 == 35 + 165.</span>  Note that this is the same operation
that Alice performed, but all of the values have been scaled up by 5
(the value of <em>G</em>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Of course, this is an oversimplified example.  When working with simple
integers, we can divide products by the generator <em>G</em> to get the
underlying scalar, which isn&#8217;t secure.  This is why a critical property
of the elliptic curve cryptography used in Bitcoin is that
multiplication is easy but division by a point on the curve is impractical.  Also, with numbers
this small, finding underlying values (or valid substitutes) through
brute force is easy; the numbers used in Bitcoin are much larger.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s discuss some of the features of the interactive schnorr
identity protocol that make it secure:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The nonce (k)</dt>
<dd>
<p>In step 1, Alice chooses a number that Bob doesn&#8217;t
  know and can&#8217;t guess and gives him the scaled form of that number,
  <em>kG</em>.  At that point, Bob also already has her public key (<em>xG</em>),
  which is the scaled form of <em>x</em>, her private key.  That means when Bob is working on
  the final equation (<em>sG</em> = <em>kG</em> + <em>exG</em>), there are two independent
  variables that Bob doesn&#8217;t know (<em>x</em> and <em>k</em>).  It&#8217;s possible to use
  simple algebra to solve an equation with one unknown variable but not
  two independent unknown variables, so the presence of Alice&#8217;s nonce
  prevents Bob from being able to derive her private key.  It&#8217;s critical
  to note that this protection depends on nonces being unguessable in
  any way.  If there&#8217;s anything predictable about Alice&#8217;s nonce, Bob may
  be able to leverage that into figuring out Alice&#8217;s private key.  See
  <a href="#nonce_warning">The Importance of Randomness in Signatures</a> for more details.</p>
</dd>
<dt class="hdlist1">The challenge scalar (e)</dt>
<dd>
<p>Bob waits to receive Alice&#8217;s public nonce
  and then proceeds in step 2 to give her a number (the challenge
  scalar) that Alice didn&#8217;t previously know and couldn&#8217;t have guessed.
  It&#8217;s critical that Bob only give her the challenge scalar after she
  commits to her public nonce.  Consider what could happen if someone
  who didn&#8217;t know <em>x</em> wanted to impersonate Alice, and Bob accidentally
  gave them the challenge scalar <em>e</em> before they told him the public
  nonce <em>kG</em>.  This allows the impersonator to change parameters on both sides of
  the equation that Bob will use for verification, <em>sG</em> == <em>kG</em> + <em>exG</em>;
  specifically, they can change both <em>sG</em> and <em>kG</em>.  Think about a
  simplified form of that expression: <em>x</em> = <em>y</em> + <em>a</em>.  If you can change both
  <em>x</em> and <em>y</em>, you can cancel out <em>a</em> using <em>x</em>' = (<em>x</em> – <em>a</em>) + <em>a</em>.  Any
  value you choose for <em>x</em> will now satisfy the equation.  For the
  actual equation the impersonator simply chooses a random number for <em>s</em>, generates
  <em>sG</em>, and then uses EC subtraction to select a <em>kG</em> that equals <em>kG</em> =
  <em>sG</em> – <em>exG</em>.  They give Bob their calculated <em>kG</em> and later their random
  <em>sG</em>, and Bob thinks that&#8217;s valid because <span class="keep-together"><em>sG</em> == (<em>sG</em> – <em>exG</em>)</span> + <em>exG</em>.
  This explains why the order of operations in the protocol is
  essential: Bob must only give Alice the challenge scalar after Alice
  has committed to her public nonce.</p>
</dd>
</dl>
</div>
<p class="fix_tracking">
The interactive identity protocol described here matches part of Claus
Schnorr's original description, but it lacks two essential features we
need for the decentralized Bitcoin network.  The first of these is that
it relies on Bob waiting for Alice to commit to her public nonce and
then Bob giving her a random challenge scalar.  In Bitcoin, the spender
of every transaction needs to be authenticated by thousands of Bitcoin
full nodes—including future nodes that haven't been started yet but
whose operators will one day want to ensure the bitcoins they receive
came from a chain of transfers where every transaction was valid.  Any
Bitcoin node that is unable to communicate with Alice, today or in the
future, will be unable to authenticate her transaction and will be in
disagreement with every other node that did authenticate it.  That's not
acceptable for a consensus system like Bitcoin.  For Bitcoin to work, we
need a protocol that doesn't require interaction between Alice and each
node that wants to authenticate her.
</p>
<div class="paragraph">
<p>A simple technique, known as the Fiat-Shamir transform after its
discoverers, can turn the schnorr interactive identity protocol
into a noninteractive digital signature scheme.  Recall the importance
of steps 1 and 2&#8212;&#8203;including that they be performed in order.  Alice must
commit to an unpredictable nonce; Bob must give Alice an unpredictable
challenge scalar only after he has received her commitment.  Recall also
the properties of secure cryptographic hash functions we&#8217;ve used
elsewhere in this book: it will always produce the same output when
given the same input but it will produce a value indistinguishable from
random data when given a different input.</p>
</div>
<div class="paragraph">
<p>This allows Alice to choose her private nonce, derive her public nonce,
and then hash the public nonce to get the challenge scalar.  Because
Alice can&#8217;t predict the output of the hash function (the challenge), and
because it&#8217;s always the same for the same input (the nonce), this
ensures that Alice gets a random challenge even though she chooses the nonce
and hashes it herself.  We no longer need interaction from Bob.  She can
simply publish her public nonce <em>kG</em> and the scalar <em>s</em>, and each of the
thousands of full nodes (past and future) can hash <em>kG</em> to produce <em>e</em>,
use that to produce <em>exG</em>, and then verify <em>sG</em> == <em>kG</em> + <em>exG</em>.  Written
explicitly, the verification equation becomes <span class="keep-together"><em>sG</em> == <em>kG</em> + <em>hash</em>(<em>kG</em>) × <em>xG</em>.</span></p>
</div>
<div class="paragraph">
<p>We need one other thing to finish converting the interactive schnorr
identity protocol into a digital signature protocol useful for
Bitcoin.  We don&#8217;t just want Alice to prove that she knows her private
key; we also want to give her the ability to commit to a message.  Specifically,
we want her to commit to the data related to the Bitcoin transaction she
wants to send.  With the Fiat-Shamir transform in place, we already
have a commitment, so we can simply have it additionally commit to the
message.  Instead of <em>hash</em>(<em>kG</em>), we now also commit to the message
<em>m</em> using <em>hash</em>(<em>kG</em> || <em>m</em>), where || stands for concatenation.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve now defined a version of the schnorr signature protocol, but
there&#8217;s one more thing we need to do to address a Bitcoin-specific
concern.  In BIP32 key derivation, as described in
<a href="#public_child_key_derivation">[public_child_key_derivation]</a>, the algorithm for unhardened derivation
takes a public key and adds to it a nonsecret value to produce a
derived public key.  That means it&#8217;s also possible to add that
nonsecret value to a valid signature for one key to produce a signature
for a related key.  That related signature is valid but it wasn&#8217;t
authorized by the person possessing the private key, which is a major
security failure.  To protect BIP32 unhardened derivation and
also support several protocols people wanted to build on top of schnorr
signatures, Bitcoin&#8217;s version of schnorr signatures, called <em>BIP340
schnorr signatures for secp256k1</em>, also commits to the public key being
used in addition to the public nonce and the message.  That makes the
full commitment <em>hash</em>(<em>kG</em> || <em>xG</em> || <em>m</em>).</p>
</div>
<div class="paragraph">
<p>Now that we&#8217;ve described each part of the BIP340 schnorr signature
algorithm and explained what it does for us, we can define the protocol.
Multiplication of integers are performed <em>modulus p</em>, indicating that the
result of the operation is divided by the number <em>p</em> (as defined in the
secp256k1 standard) and the remainder is used.  The number <em>p</em> is very
large, but if it was 3 and the result of an operation was 5, the actual
number we would use is 2 (i.e., 5 divided by 3 has a remainder of 2).</p>
</div>
<div class="paragraph">
<p>Setup: Alice chooses a large random number (<em>x</em>) as her private key
(either directly or by using a protocol like BIP32 to deterministically
generate a private key from a large random seed value).  She uses the
parameters defined in secp256k1 (see <a href="#elliptic_curve">[elliptic_curve]</a>) to multiply the
generator <em>G</em> by her scalar <em>x</em>, producing <em>xG</em> (her public key).  She
gives her public key to everyone who will later authenticate her Bitcoin
transactions (e.g., by having <em>xG</em> included in a transaction output).  When
she&#8217;s ready to spend, she begins generating her signature:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Alice chooses a large random private nonce <em>k</em> and derives the public
nonce <em>kG</em>.</p>
</li>
<li>
<p>She chooses her message <em>m</em> (e.g., transaction data) and generates the
challenge scalar <em>e</em> = <em>hash</em>(<em>kG</em> || <em>xG</em> || <em>m</em>).</p>
</li>
<li>
<p>She produces the scalar <em>s</em> = <em>k</em> + <em>ex</em>.  The two values <em>kG</em> and <em>s</em>
are her signature.  She gives this signature to everyone who wants to
verify that signature; she also needs to ensure everyone receives her
message <em>m</em>.  In Bitcoin, this is done by including her signature in
the witness structure of her spending transaction and then relaying that
transaction to full nodes.</p>
</li>
<li>
<p>The verifiers (e.g., full nodes) use <em>s</em> to derive <em>sG</em> and then
verify that <em>sG</em> == <em>kG</em> + <em>hash</em>(<em>kG</em> || <em>xG</em> || <em>m</em>) × <em>xG</em>.  If the equation is
valid, Alice proved that she knows her private key <em>x</em> (without
revealing it) and committed to the message <em>m</em> (containing the
transaction data).</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_serialization_of_schnorr_signatures">Serialization of Schnorr Signatures</h4>
<div class="paragraph">
<p>A schnorr signature consists of two values, <em>kG</em> and <em>s</em>.  The value
<em>kG</em> is a point on Bitcoin&#8217;s elliptic curve (called secp256k1) and would normally be represented by two 32-byte coordinates, e.g., (<em>x</em>, <em>y</em>).
However, only the <em>x</em> coordinate is needed, so only that value is
included.  When you see <em>kG</em> in schnorr signatures for Bitcoin, note that it&#8217;s only that point&#8217;s <em>x</em>
coordinate.</p>
</div>
<div class="paragraph">
<p>The value <em>s</em> is a scalar (a number meant to multiply other numbers).  For
Bitcoin&#8217;s secp256k1 curve, it can never be more than 32 bytes long.</p>
</div>
<div class="paragraph">
<p>Although both <em>kG</em> and <em>s</em> can sometimes be values that can be
represented with fewer than 32 bytes, it&#8217;s improbable that they&#8217;d be
much smaller than 32 bytes, so they&#8217;re serialized as two 32-byte
values (i.e., values smaller than 32 bytes have leading zeros).
They&#8217;re serialized in the order of <em>kG</em> and then <em>s</em>, producing exactly
64 bytes.</p>
</div>
<div class="paragraph">
<p>The taproot soft fork, also called v1 segwit, introduced schnorr signatures
to Bitcoin and is the only way they are used in Bitcoin as of this writing.  When
used with either taproot keypath or scriptpath spending, a 64-byte
schnorr signature is considered to use a default signature hash (sighash)
that is SIGHASH_ALL.  If an alternative sighash is used, or if the
spender wants to waste space to explicitly specify SIGHASH_ALL, a
single additional byte is appended to the signature that specifies the
signature hash, making the signature 65 bytes.</p>
</div>
<div class="paragraph">
<p>As we&#8217;ll see, either 64 or 65 bytes is considerably more efficient that
the serialization used for ECDSA signatures described in
<a href="#serialization_of_signatures_der">Serialization of ECDSA Signatures (DER)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="schnorr_multisignatures">Schnorr-based Scriptless Multisignatures</h4>
<div class="paragraph">
<p>In the single-signature schnorr protocol described in <a href="#schnorr_signatures">Schnorr Signatures</a>, Alice
uses a signature (<em>kG</em>, <em>s</em>) to publicly prove her knowledge of her
private key, which in this case we&#8217;ll call <em>y</em>.  Imagine if Bob also has
a private key (<em>z</em>) and he&#8217;s willing to work with Alice to prove that
together they know <em>x</em> = <em>y</em> + <em>z</em> without either of them revealing their
private key to each other or anyone else.  Let&#8217;s go through the BIP340
schnorr signature protocol again.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>The simple protocol we are about to describe is not secure for the
reasons we will explain shortly.  We use it only to demonstrate the
mechanics of schnorr multisignatures before describing related protocols
that are believed to be secure.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alice and Bob need to derive the public key for <em>x</em>, which is <em>xG</em>.
Since it&#8217;s possible to use elliptic curve operations to add two EC
points together, they start by Alice deriving <em>yG</em> and Bob deriving
<em>zG</em>.  They then add them together to create <span class="keep-together"><em>xG</em> = <em>yG</em> + <em>zG</em>.</span>  The point
<em>xG</em> is their <em>aggregated public key</em>.  To create a signature, they begin the
simple multisignature protocol:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>They each individually choose a large random private nonce, <em>a</em> for
Alice and <em>b</em> for Bob.  They also individually derive the corresponding
public nonce <em>aG</em> and <em>bG</em>.  Together, they produce an aggregated
public nonce <em>kG</em> = <em>aG</em> + <em>bG</em>.</p>
</li>
<li>
<p>They agree on the message to sign, <em>m</em> (e.g., a transaction), and
each generates a copy of the challenge scalar: <em>e</em> = <em>hash</em>(<em>kG</em> || <em>xG</em> || <em>m</em>).</p>
</li>
<li>
<p>Alice produces the scalar <em>q</em> = <em>a</em> + <em>ey</em>.  Bob produces the scalar
<em>r</em> = <em>b</em> + <em>ez</em>.  They add the scalars together to produce
<em>s</em> = <em>q</em> + <em>r</em>.  Their signature is the two values <em>kG</em> <span class="keep-together">and <em>s</em>.</span></p>
</li>
<li>
<p>The verifiers check their public key and signature using the normal
equation: <span class="keep-together"><em>sG</em> ==</span> <em>kG</em> + <em>hash</em>(<em>kG</em> || <em>xG</em> || <em>m</em>) × <em>xG</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Alice and Bob have proven that they know the sum of their private keys without
either one of them revealing their private key to the other or anyone
else.  The protocol can be extended to any number of participants (e.g.,
a million people could prove they knew the sum of their million
different keys).</p>
</div>
<div class="paragraph">
<p>The preceding protocol has several security problems.  Most notable is that one
party might learn the public keys of the other parties before committing
to their own public key.  For example, Alice generates her public key
<em>yG</em> honestly and shares it with Bob.  Bob generates his public key
using <em>zG</em> – <em>yG</em>.  When their two keys are combined <span class="keep-together">(<em>yG</em> + <em>zG</em> – <em>yG</em>),</span> the
positive and negative <em>yG</em> terms cancel out so the public key only represents
the private key for <em>z</em> (i.e., Bob&#8217;s private key).  Now Bob can create a
valid signature without any assistance from Alice.  This is called a
<em>key cancellation attack</em>.</p>
</div>
<div class="paragraph">
<p>There are various ways to solve the key cancellation attack.  The
simplest scheme would be to require each participant commit to their
part of the public key before sharing anything about that key with all
of the other participants.  For example, Alice and Bob each individually
hash their public keys and share their digests with each other.  When
they both have the other&#8217;s digest, they can share their keys.  They
individually check that the other&#8217;s key hashes to the previously
provided digest and then proceed with the protocol normally.  This prevents
either one of them from choosing a public key that cancels out the keys
of the other participants.  However, it&#8217;s easy to fail to implement this
scheme correctly, such as using it in a naive way with unhardened
BIP32 public key derivation.  Additionally, it adds an extra step for
communication between the participants, which may be undesirable in many
cases.  More complex schemes have been proposed that address these
shortcomings.</p>
</div>
<div class="paragraph">
<p>In addition to the key cancellation attack, there are a number of
attacks possible against nonces.  Recall that the purpose of the nonce
is to prevent anyone from being able to use their knowledge of other values
in the signature verification equation to solve for your private key,
determining its value.  To effectively accomplish that, you must use a
different nonce every time you sign a different message or change other
signature parameters.  The different nonces must not be related in any
way.  For a multisignature, every participant must follow these rules or
it could compromise the security of other participants.  In addition,
cancellation and other attacks need to be prevented.  Different
protocols that accomplish these aims make different trade-offs, so
there&#8217;s no single multisignature protocol to recommend in all cases.
Instead, we&#8217;ll note three from the MuSig family of protocols:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">MuSig</dt>
<dd>
<p>Also called <em>MuSig1</em>, this protocol requires three rounds of
communication during the signing process, making it similar to the
process we just described.  MuSig1&#8217;s greatest advantage is its
simplicity.</p>
</dd>
<dt class="hdlist1">MuSig2</dt>
<dd>
<p>This only requires two rounds of communication and can sometimes allow
one of the rounds to be combined with key exchange.  This can
significantly speed up signing for certain protocols, such as how
scriptless multisignatures are planned to be used in the LN.  MuSig2 is specified in BIP327 (the only scriptless
multisignature protocol that has a BIP as of this writing).</p>
</dd>
<dt class="hdlist1">MuSig-DN</dt>
<dd>
<p>DN stands for Deterministic Nonce, which eliminates as a concern a
problem known as the <em>repeated session attack</em>.  It can&#8217;t be combined
with key exchange and it&#8217;s significantly more complex to implement
than MuSig or MuSig2.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For most applications, MuSig2 is the best multisignature protocol
available at the time of writing.</p>
</div>
</div>
<div class="sect3">
<h4 id="schnorr_threshold_signatures">Schnorr-based Scriptless Threshold Signatures</h4>
<div class="paragraph">
<p>Scriptless multisignature protocols only work for <em>k</em>-of-<em>k</em> signing.
Everyone with a partial public key that becomes part of the aggregated
public key must contribute a partial signature and partial nonce to the
final signature.  Sometimes, though, the participants want to allow a
subset of them to sign, such as <em>t</em>-of-<em>k</em> where a threshold (<em>t</em>) number of participants can sign for
a key constructed by <em>k</em> participants.  That type of signature is called a
<em>threshold signature</em>.</p>
</div>
<div class="paragraph">
<p>We saw script-based threshold signatures in
<a href="#multisig">[multisig]</a>.  But just as
scriptless multisignatures save space and increase privacy compared to
scripted multisignatures, <em>scriptless threshold signatures</em> save space and
increase privacy compared to <em>scripted threshold signatures</em>.  To anyone
not involved in the signing, a <em>scriptless threshold signature</em> looks
like any other signature that could&#8217;ve been created by a single-sig
user or through a scriptless multisignature protocol.</p>
</div>
<div class="paragraph">
<p>Various methods are known for generating scriptless threshold
signatures, with the simplest being a slight modification of how we
created scriptless multisignatures previously.  This protocol also
depends on verifiable secret sharing (which itself depends on secure
secret sharing).</p>
</div>
<div class="paragraph">
<p>Basic secret sharing can work through simple splitting.  Alice has a
secret number that she splits into three equal-length parts and shares
with Bob, Carol, and Dan.  Those three can combine the partial numbers
they received (called <em>shares</em>) in the correct order to reconstruct
Alice&#8217;s secret.  A more sophisticated scheme would involve Alice adding
on some additional information to each share, called a correction code,
that allows any two of them to recover the number.  This scheme is not
secure because each share gives its holder partial knowledge of Alice&#8217;s
secret, making it easier for the participant to guess Alice&#8217;s secret
than a nonparticipant who didn&#8217;t have a share.</p>
</div>
<div class="paragraph">
<p>A secure secret sharing scheme prevents participants from learning
anything about the secret unless they combine the minimum threshold
number of shares.  For example, Alice can choose a threshold of
2 if she wants any two of Bob, Carol, and Dan to be able to
reconstruct her secret.  The best known secure secret sharing algorithm
is <em>Shamir&#8217;s Secret Sharing Scheme</em>, commonly abbreviated SSSS and named
after its discoverer, one of the same discoverers of the Fiat-Shamir
transform we saw in <a href="#schnorr_signatures">Schnorr Signatures</a>.</p>
</div>
<div class="paragraph">
<p>In some cryptographic protocols, such as the scriptless threshold signature
schemes we&#8217;re working toward, it&#8217;s critical for Bob, Carol, and Dan to
know that Alice followed her side of the protocol correctly.  They need to
know that the shares she creates all derive from the same secret, that
she used the threshold value she claims, and that she gave each one of
them a different share.  A protocol that can accomplish all of that,
and still be a secure secret sharing scheme, is a <em>verifiable secret
sharing scheme</em>.</p>
</div>
<div class="paragraph">
<p>To see how multisignatures and verifiable secret sharing work for
Alice, Bob, and Carol, imagine they each wish to receive funds that can
be spent by any two of them.  They collaborate as described in
<a href="#schnorr_multisignatures">Schnorr-based Scriptless Multisignatures</a> to produce a regular multisignature public
key to accept the funds (k-of-k).  Then each participant derives two
secret shares from their private key&#8212;&#8203;one for each of two the other
participants. The shares allow any two of them to reconstruct the
originating partial private key for the multisignature. Each participant
distributes one of their secret shares to the other two participants,
resulting in each participant storing their own partial private key and
one share for every other participant. Subsequently, each participant
verifies the authenticity and uniqueness of the shares they received
compared to the shares given to the other participants.</p>
</div>
<div class="paragraph">
<p>Later on, when (for example) Alice and Bob want to generate a scriptless
threshold signature without Carol&#8217;s involvement, they exchange the two
shares they possess for Carol. This enables them to reconstruct Carol&#8217;s
partial private key.  Alice and Bob also have their private keys,
allowing them to create a scriptless multisignature with all three
necessary keys.</p>
</div>
<div class="paragraph">
<p>In other words, the scriptless threshold signature scheme just described
is the same as a scriptless multisignature scheme except that
a threshold number of participants have the ability to reconstruct the
partial private keys of any other participants who are unable or
unwilling to sign.</p>
</div>
<div class="paragraph">
<p>This does point to a few things to be aware about when considering a
scriptless threshold signature protocol:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">No accountability</dt>
<dd>
<p>Because Alice and Bob reconstruct Carol&#8217;s partial
private key, there can be no fundamental difference between a scriptless
multisignature produced by a process that involved Carol and one that
didn&#8217;t.  Even if Alice, Bob, or Carol claim that they didn&#8217;t sign,
there&#8217;s no guaranteed way for them to prove that they didn&#8217;t
help produce the signature.  If it&#8217;s important to know which members of
the group signed, you will need to use a script.</p>
</dd>
<dt class="hdlist1">Manipulation attacks</dt>
<dd>
<p>Imagine that Bob tells Alice that Carol is
unavailable, so they work together to reconstruct Carol&#8217;s partial
private key.  Then Bob tells Carol that Alice is unavailable, so they
work together to reconstruct Alice&#8217;s partial private key.  Now Bob has
his own partial private key plus the keys of Alice and Carol, allowing
him to spend the funds himself without their involvement.  This attack can
be addressed if all of the participants agree to only communicate using a
scheme that allows any one of them to see all of the other&#8217;s messages
(e.g., if Bob tells Alice that Carol is unavailable, Carol is able to see
that message before she begins working with Bob).  Other solutions,
possibly more robust solutions, to this problem were being researched at
the time of writing.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>No scriptless threshold signature protocol has been proposed as a BIP
yet, although significant research into the subject has been performed
by multiple Bitcoin contributors and we expect peer-reviewed solutions
will become available after the publication of this book.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ecdsa_signatures">ECDSA Signatures</h3>
<div class="paragraph">
<p>Unfortunately for the future development of Bitcoin and many other
applications, Claus Schnorr patented the algorithm he discovered and
prevented its use in open standards and open source software for almost
two decades.  Cryptographers in the early 1990s who were blocked from
using the schnorr signature scheme developed an alternative construction
called the <em>Digital Signature Algorithm</em> (DSA), with a version adapted
to elliptic curves called ECDSA.</p>
</div>
<div class="paragraph">
<p>The ECDSA scheme and standardized parameters for suggested curves it could be used
with were widely implemented in cryptographic libraries by the time
development on Bitcoin began in 2007.  This was almost certainly the
reason why ECDSA was the only digital signature protocol that Bitcoin
supported from its first release version until the activation of the
taproot soft fork in 2021.  ECDSA remains supported today for all
non-taproot transactions.  Some of the differences compared to schnorr
signatures include:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">More complex</dt>
<dd>
<p>As we&#8217;ll see, ECDSA requires more operations to create or verify a
signature than the schnorr signature protocol.  It&#8217;s not significantly
more complex from an implementation standpoint, but that extra
complexity makes ECDSA less flexible, less performant, and harder to
prove secure.</p>
</dd>
<dt class="hdlist1">Less provable security</dt>
<dd>
<p>The interactive schnorr signature identification protocol depends only
on the strength of the elliptic curve Discrete Logarithm Problem
(ECDLP).  The non-interactive authentication protocol used in Bitcoin
also relies on the random oracle model (ROM).  However, ECDSA&#8217;s extra
complexity has prevented a complete proof of its security being
published (to the best of our knowledge).  We are not experts in
proving cryptographic algorithms, but it seems unlikely after 30 years
that ECDSA will be proven to only require the same two assumptions as
schnorr.</p>
</dd>
<dt class="hdlist1">Nonlinear</dt>
<dd>
<p>ECDSA signatures cannot be easily combined to create scriptless
multisignatures or used in related advanced applications, such as
multiparty signature adaptors.  There are workarounds for this
problem, but they involve additional extra complexity that
significantly slows down operations and which, in some cases, has
resulted in software accidentally leaking private keys.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_ecdsa_algorithm">ECDSA Algorithm</h4>
<div class="paragraph">
<p>Let&#8217;s look at the math of ECDSA.
Signatures are created by a mathematical function <em>F</em><sub><em>sig</em></sub>
that produces a signature composed of two values.  In ECDSA, those two
values are <em>R</em> and <em>s</em>.</p>
</div>
<div class="paragraph">
<p>The signature
algorithm first generates a private nonce (<em>k</em>) and derives from it a public
nonce (<em>K</em>).  The <em>R</em> value of the digital signature is then the <em>x</em>
coordinate of the nonce <em>K</em>.</p>
</div>
<div class="paragraph">
<p>From there, the algorithm calculates the <em>s</em> value of the signature.  Like we did with schnorr signatures, operations involving
integers are modulus p:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
s = k^{-1} (Hash(m) + x \times R)
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>k</em> is the private nonce</p>
</li>
<li>
<p><em>R</em> is the <em>x</em> coordinate of the public nonce</p>
</li>
<li>
<p><em>x</em> is the Alice&#8217;s private key</p>
</li>
<li>
<p><em>m</em> is the message (transaction data)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Verification is the inverse of the signature generation function, using
the <em>R</em>, <em>s</em> values and the public key to calculate a value <em>K</em>, which
is a point on the elliptic curve (the public nonce used in
signature creation):</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
K = s^{-1} \times Hash(m) \times G + s^{-1} \times R \times X
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>R</em> and <em>s</em> are the signature values</p>
</li>
<li>
<p><em>X</em> is Alice&#8217;s public key</p>
</li>
<li>
<p><em>m</em> is the message (the transaction data that was signed)</p>
</li>
<li>
<p><em>G</em> is the elliptic curve generator point</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the <em>x</em> coordinate of the calculated point <em>K</em> is equal to <em>R</em>, then
the verifier can conclude that the signature is valid.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>ECDSA is necessarily a fairly complicated piece of math; a full
explanation is beyond the scope of this book. A number of great guides
online take you through it step by step: search for "ECDSA explained."</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="serialization_of_signatures_der">Serialization of ECDSA Signatures (DER)</h4>
<div class="paragraph">
<p>Let&#8217;s look at
the following DER-encoded signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204
b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e381301</pre>
</div>
</div>
<div class="paragraph">
<p>That signature is a serialized byte stream of the <em>R</em> and <em>s</em> values
produced by the signer to prove control of the private key authorized
to spend an output. The serialization format consists of nine elements
as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x30, indicating the start of a DER sequence</p>
</li>
<li>
<p>0x45, the length of the sequence (69 bytes)</p>
</li>
<li>
<p>0x02, an integer value follows</p>
</li>
<li>
<p>0x21, the length of the integer (33 bytes)</p>
</li>
<li>
<p>R, 00884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb</p>
</li>
<li>
<p>0x02, another integer follows</p>
</li>
<li>
<p>0x20, the length of the integer (32 bytes)</p>
</li>
<li>
<p>S, 4b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813</p>
</li>
<li>
<p>A suffix (0x01) indicating the type of hash used (SIGHASH_ALL)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="nonce_warning">The Importance of Randomness in Signatures</h3>
<div class="paragraph">
<p>As we saw in <a href="#schnorr_signatures">Schnorr Signatures</a> and <a href="#ecdsa_signatures">ECDSA Signatures</a>,
the signature generation algorithm uses a random number <em>k</em> as the basis
for a private/public nonce pair. The value of <em>k</em> is not
important, <em>as long as it is random</em>. If signatures from the same
private key use the private nonce <em>k</em> with different messages
(transactions), then the
signing <em>private key</em> can be calculated by anyone. Reuse of the same
value for <em>k</em> in a signature algorithm leads to exposure of the private
key!</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the same value <em>k</em>
is used in the signing algorithm on two different transactions, the
private key can be calculated and exposed to the world!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is not just a theoretical possibility. We have seen this issue lead
to exposure of private keys in a few different implementations of
transaction-signing algorithms in Bitcoin. People have had funds stolen
because of inadvertent reuse of a <em>k</em> value. The most common reason for
reuse of a <em>k</em> value is an improperly initialized random-number
generator.</p>
</div>
<div class="paragraph">
<p>To avoid this
vulnerability, the industry best practice is to not generate <em>k</em> with a
random-number generator seeded only with entropy, but instead to use a
process seeded in part with the transaction data itself plus the
private key being used to sign.
This ensures that each transaction produces a different <em>k</em>. The
industry-standard algorithm for deterministic initialization of <em>k</em> for
ECDSA is defined in <a href="https://oreil.ly/yuabl">RFC6979</a>, published by
the Internet Engineering Task Force.  For schnorr signatures, BIP340
recommends a default signing algorithm.</p>
</div>
<div class="paragraph">
<p>BIP340 and RFC6979 can generate <em>k</em> entirely deterministically, meaning the same
transaction data will always produce the same <em>k</em>.  Many wallets do this
because it makes it easy to write tests to verify their safety-critical
signing code is producing <em>k</em> values correctly.  BIP340 and RFC6979 both also allow
including additional data in the calculation.  If that data is entropy,
then a different <em>k</em> will be produced even if the exact same transaction
data is signed.  This can increase protection against sidechannel and
fault-injection attacks.</p>
</div>
<div class="paragraph">
<p>If you are implementing an algorithm to sign transactions in Bitcoin,
you <em>must</em> use BIP340, RFC6979, or a similar algorithm to
ensure you generate a different <em>k</em> for each transaction.</p>
</div>
</div>
<div class="sect2">
<h3 id="_segregated_witnesss_new_signing_algorithm">Segregated Witness&#8217;s New Signing Algorithm</h3>
<div class="paragraph">
<p>Signatures in Bitcoin transactions are applied on a <em>commitment hash</em>,
which is calculated from the transaction data, locking specific parts of
the data indicating the signer&#8217;s commitment to those values. For
example, in a simple SIGHASH_ALL type signature, the commitment hash
includes all inputs and outputs.</p>
</div>
<div class="paragraph">
<p>Unfortunately, the way the legacy commitment hashes were calculated introduced the
possibility that a node verifying a signature can be forced to perform
a significant number of hash computations. Specifically, the hash
operations increase roughly quadratically with respect to the number of
inputs in the transaction. An attacker could therefore create a
transaction with a very large number of signature operations, causing
the entire Bitcoin network to have to perform hundreds or thousands of
hash operations to verify the transaction.</p>
</div>
<div class="paragraph">
<p>Segwit represented an opportunity to address this problem by changing
the way the commitment hash is calculated. For segwit version 0 witness
programs, signature verification occurs using an improved commitment
hash algorithm as specified in BIP143.</p>
</div>
<div class="paragraph">
<p>The new algorithm allows the number of
hash operations to increase by a much more gradual O(n) to the number of
signature operations, reducing the opportunity to create
denial-of-service attacks with overly complex transactions.</p>
</div>
<div class="paragraph">
<p>In this chapter, we learned about schnorr and ECDSA signatures for
Bitcoin.  This explains how full nodes authenticate transactions to
ensure that only someone controlling the key to which bitcoins were
received can spend those bitcoins.  We also examined several advanced
applications of signatures, such as scriptless multisignatures and
scriptless threshold signatures that can be used to improve the
efficiency and privacy of Bitcoin.  In the past few chapters, we&#8217;ve
learned how to create transactions, how to secure them with
authorization and authentication, and how to sign them.  We will next
learn how to encourage miners to confirm them by adding fees to the
transactions we create.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-03-19 23:56:16 +0800
</div>
</div>
</body>
</html>